<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>FocusForge ‚Äî Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root{
    --bg:#04102a;
    --surface:#071827;
    --muted:#94a3b8;
    --accent:#60a5fa;
    --accent-2:#7c3aed;
    --success:#34d399;
    --danger:#ef4444;
    --card:#0b1724;
    --radius:8px;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;}
  html,body{height:100%;background:linear-gradient(180deg,var(--bg),var(--surface));color:#e8f2ff;-webkit-font-smoothing:antialiased;}
  a{color:inherit}
  .app{min-height:100vh;display:flex;flex-direction:column;background:linear-gradient(180deg,var(--bg),var(--surface));}
  header.app-header{padding:0.75rem;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));gap:1rem;border-bottom:1px solid rgba(255,255,255,0.03);}
  .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#021025;flex-shrink:0;font-size:0.8rem;}
  .title h1{font-size:1.1rem;margin:0}
  .sub{font-size:0.7rem;color:var(--muted);margin-top:0.1rem;}
  .header-actions{display:flex;gap:0.4rem;align-items:center}
  .icon-btn{width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.02);cursor:pointer;color:var(--muted);flex-shrink:0;font-size:0.9rem;}
  
  .user-info{display:flex;align-items:center;gap:0.5rem;}
  .user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:600;color:#021025;font-size:0.9rem;cursor:pointer;transition:transform 0.2s ease;border:2px solid rgba(255,255,255,0.1);}
  .user-avatar:hover{transform:scale(1.05);}
  .user-text{display:none;}

  .account-modal {
    width: 100%;
    max-width: 400px;
  }
  
  .account-info {
    background: rgba(255,255,255,0.02);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(255,255,255,0.05);
  }
  
  .account-field {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  
  .account-field:last-child {
    border-bottom: none;
  }
  
  .account-label {
    color: var(--muted);
    font-size: 0.9rem;
  }
  
  .account-value {
    font-weight: 600;
    color: #e8f2ff;
  }
  
  .edit-username {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    display: none;
  }
  
  .edit-username input {
    flex: 1;
    padding: 0.5rem;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.05);
    color: #eaf3ff;
  }

  .main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
  .content{flex:1;padding:0.75rem;overflow-y:auto;}
  section.app-section{display:none;height:100%;}
  section.app-section.active{display:block;}
  .section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem;flex-wrap:wrap;gap:0.5rem;}
  .small-muted{font-size:0.7rem;color:var(--muted);}
  .grid{display:grid;gap:0.5rem;grid-template-columns:1fr;}
  
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
    border-radius:var(--radius);
    padding:0.6rem;
    display:flex;
    gap:0.6rem;
    align-items:center;
    border:1px solid rgba(255,255,255,0.03);
    position:relative;
    transition:transform 0.2s ease, box-shadow 0.2s ease;
    min-height: auto;
  }
  .card:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(2,6,23,0.4);}
  
  .progress{
    width:36px;
    height:36px;
    flex:0 0 36px;
    display:grid;
    place-items:center;
    position:relative;
  }
  .progress svg{
    transform:rotate(-90deg);
    width:36px;
    height:36px;
  }
  .progress .center{
    position:absolute;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    font-size:0.55rem;
    color:#e6eef8;
    line-height:1;
  }
  .progress .center div:first-child{
    font-weight:800;
    font-size:0.65rem;
  }
  
  .meta{flex:1;min-width:0;}
  .habit-name{
    font-weight:700;
    font-size:0.8rem;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    margin-bottom:0.1rem;
    line-height:1.2;
  }
  .habit-note{
    font-size:0.65rem;
    color:var(--muted);
    margin-bottom:0.3rem;
    line-height:1.2;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-clamp: 1;
  }
  .habit-meta-row{
    display:flex;
    gap:0.3rem;
    align-items:center;
    flex-wrap:wrap;
    margin-bottom:0.2rem;
  }
  .chip{
    font-size:0.6rem;
    padding:0.15rem 0.3rem;
    border-radius:6px;
    background:rgba(255,255,255,0.02);
    border:1px solid rgba(255,255,255,0.02);
    color:var(--muted);
  }
  .habit-actions{
    display:flex;
    gap:0.3rem;
    align-items:center;
    margin-top:0.3rem;
  }
  .btn{
    padding:0.3rem 0.5rem;
    border-radius:5px;
    border:none;
    cursor:pointer;
    font-weight:600;
    font-size:0.65rem;
    display:inline-flex;
    gap:0.15rem;
    align-items:center;
    justify-content:center;
    transition:all 0.2s ease;
    line-height:1;
  }
  .btn-mark{
    background:linear-gradient(90deg,var(--success),#10b981);
    color:#021;
    border:none;
  }
  .btn-more{
    background:transparent;
    border:1px solid rgba(255,255,255,0.03);
    color:var(--muted);
    padding:0.3rem;
    border-radius:5px;
    width:24px;
    height:24px;
  }
  
  .history{display:none !important;}
  
  .fab.habit-fab {
    position: fixed;
    right: 1rem;
    bottom: 5rem;
    z-index: 30;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: grid;
    place-items: center;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: #021025;
    font-size: 1rem;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
    border: none;
    transition: transform 0.2s ease;
    display: none;
  }
  .fab.habit-fab:hover{transform:scale(1.1);}
  
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.8);display:none;align-items:center;justify-content:center;z-index:40;padding:1rem;}
  .modal{width:100%;max-width:500px;background:linear-gradient(180deg,#061025,#07142a);border-radius:1rem;padding:1.25rem;border:1px solid rgba(255,255,255,0.03);color:#eaf3ff;max-height:90vh;overflow-y:auto;}
  .form-row{display:flex;flex-direction:column;gap:0.5rem;margin-bottom:1rem;}
  .form-row label{color:var(--muted);font-size:0.9rem;font-weight:500;}
  .form-row input,.form-row select,textarea{width:100%;padding:0.75rem;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:#eaf3ff;outline:none;font-size:1rem;transition:border-color 0.2s ease;}
  .form-row input:focus,.form-row select:focus{outline:none;border-color:var(--accent);}
  .form-row select option{background:#061025;color:#eaf3ff;padding:0.5rem;}
  .modal .actions{display:flex;gap:0.75rem;justify-content:flex-end;margin-top:1.5rem;}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--muted);padding:0.75rem 1.25rem;border-radius:8px;cursor:pointer;transition:all 0.2s ease;}
  .ghost:hover{background:rgba(255,255,255,0.05);}
  .btn-modal{background:linear-gradient(90deg,var(--success),#10b981);color:#021;border:none;padding:0.75rem 1.5rem;border-radius:8px;cursor:pointer;font-weight:600;transition:transform 0.2s ease;}
  .btn-modal:hover{transform:translateY(-1px);}
  .more-menu{position:absolute;background:#061025;border:1px solid rgba(255,255,255,0.1);padding:0.4rem;border-radius:6px;z-index:50;display:none;min-width:120px;box-shadow:0 4px 12px rgba(0,0,0,0.3);}
  .more-menu button{display:block;background:transparent;border:none;color:var(--muted);padding:0.5rem 0.75rem;width:100%;text-align:left;cursor:pointer;border-radius:4px;font-size:0.8rem;transition:all 0.2s ease;}
  .more-menu button:hover{background:rgba(255,255,255,0.05);color:#e6eef8}
  .bottom-nav{display:flex;justify-content:space-around;align-items:center;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-top:1px solid rgba(255,255,255,0.03);padding:0.5rem;gap:0.25rem;margin-top:auto;}
  .nav-item{text-align:center;flex:1;color:var(--muted);font-size:0.65rem;cursor:pointer;padding:0.4rem 0.2rem;display:flex;flex-direction:column;align-items:center;gap:0.2rem;transition:all 0.2s ease;border-radius:6px;}
  .nav-item:hover{background:rgba(255,255,255,0.02);}
  .nav-item.active{color:var(--accent);}
  .nav-item i{font-size:1rem;}
  .feed{display:flex;flex-direction:column;gap:0.75rem;}
  .post{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border-radius:10px;padding:0.75rem;border:1px solid rgba(255,255,255,0.02)}
  footer.app-footer{padding:0.75rem;border-top:1px solid rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:0.7rem;background:transparent;}
  .empty{text-align:center;padding:2rem 1rem;color:var(--muted);display:none;}
  .empty i{font-size:2rem;margin-bottom:0.75rem;opacity:0.5;}
  .empty div{font-size:0.9rem;}
  .loading{display:flex;justify-content:center;align-items:center;height:100vh;background:var(--bg);color:white;flex-direction:column;gap:1rem;}
  .loading .logo{width:50px;height:50px;font-size:1.2rem;}

  /* FRIENDS SECTION - SINGLE LINE LAYOUT */
  .friend-card {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius: var(--radius);
    padding: 0.6rem;
    display: flex;
    gap: 0.6rem;
    align-items: center;
    border: 1px solid rgba(255,255,255,0.03);
    position: relative;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    min-height: auto;
    margin-bottom: 0.5rem;
  }
  
  .friend-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(2,6,23,0.4);
  }
  
  .friend-avatar {
    width: 36px;
    height: 36px;
    flex: 0 0 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: #021025;
    font-size: 0.8rem;
  }
  
  .friend-meta {
    flex: 1;
    min-width: 0;
  }
  
  .friend-name {
    font-weight: 700;
    font-size: 0.8rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 0.1rem;
    line-height: 1.2;
  }
  
  .friend-email {
    font-size: 0.65rem;
    color: var(--muted);
    margin-bottom: 0.3rem;
    line-height: 1.2;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-clamp: 1;
  }
  
  .friend-status {
    font-size: 0.6rem;
    padding: 0.15rem 0.3rem;
    border-radius: 6px;
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.02);
    color: var(--muted);
    display: inline-block;
  }
  
  .friend-actions {
    display: flex;
    gap: 0.3rem;
    align-items: center;
  }
  
  .btn-chat {
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: #021025;
    border: none;
    padding: 0.3rem 0.5rem;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.65rem;
    display: inline-flex;
    gap: 0.15rem;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    line-height: 1;
  }
  
  .btn-remove {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.03);
    color: var(--muted);
    padding: 0.3rem;
    border-radius: 5px;
    width: 24px;
    height: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  /* REQUEST CARDS */
  .request-card {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius: var(--radius);
    padding: 0.6rem;
    display: flex;
    gap: 0.6rem;
    align-items: center;
    border: 1px solid rgba(255,255,255,0.03);
    position: relative;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    min-height: auto;
    margin-bottom: 0.5rem;
  }
  
  .request-avatar {
    width: 36px;
    height: 36px;
    flex: 0 0 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: #021025;
    font-size: 0.8rem;
  }
  
  .request-meta {
    flex: 1;
    min-width: 0;
  }
  
  .request-name {
    font-weight: 700;
    font-size: 0.8rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 0.1rem;
    line-height: 1.2;
  }
  
  .request-text {
    font-size: 0.65rem;
    color: var(--muted);
    margin-bottom: 0.3rem;
    line-height: 1.2;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-clamp: 1;
  }
  
  .request-actions {
    display: flex;
    gap: 0.3rem;
    align-items: center;
  }
  
  .btn-success-small {
    background: var(--success);
    color: #021025;
    border: none;
    padding: 0.3rem 0.5rem;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.65rem;
    display: inline-flex;
    gap: 0.15rem;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    line-height: 1;
  }
  
  .btn-danger-small {
    background: var(--danger);
    color: white;
    border: none;
    padding: 0.3rem 0.5rem;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.65rem;
    display: inline-flex;
    gap: 0.15rem;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    line-height: 1;
  }
  
  .empty-friends, .empty-status {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--muted);
  }
  
  .empty-friends i, .empty-status i {
    font-size: 2rem;
    margin-bottom: 0.75rem;
    opacity: 0.5;
  }
  
  .requests-container {
    background: rgba(255,255,255,0.02);
    border-radius: 10px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
  }
  
  .requests-title {
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: var(--accent);
    font-size: 0.8rem;
  }
  
  .user-avatar-small {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: #021025;
    font-size: 0.6rem;
    flex-shrink: 0;
  }
  
  .message {
    margin-bottom: 0.75rem;
    padding: 0.6rem;
    border-radius: 10px;
    max-width: 80%;
  }
  
  .own-message {
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    margin-left: auto;
    color: #021025;
  }
  
  .other-message {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  .message-text {
    font-size: 0.8rem;
    line-height: 1.3;
  }
  
  .message-time {
    font-size: 0.6rem;
    opacity: 0.7;
    margin-top: 0.2rem;
    text-align: right;
  }
  
  .status-text {
    font-size: 0.85rem;
    line-height: 1.3;
    color: #e8f2ff;
  }
  
  .chat-modal {
    width: 100%;
    max-width: 400px;
    height: 70vh;
    display: flex;
    flex-direction: column;
  }
  
  .messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
  }
  
  .chat-input-container {
    display: flex;
    gap: 0.4rem;
    padding: 0.75rem;
    border-top: 1px solid rgba(255,255,255,0.1);
  }
  
  .chat-input {
    flex: 1;
    padding: 0.6rem;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.05);
    color: #eaf3ff;
    outline: none;
    font-size: 0.8rem;
  }
  
  .send-btn {
    padding: 0.6rem 0.8rem;
    border-radius: 16px;
    border: none;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: #021025;
    cursor: pointer;
    font-size: 0.8rem;
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  @media (max-width: 768px) {
    .content {
      padding: 0.5rem;
      padding-bottom: 5rem;
    }
    
    .grid {
      gap: 0.4rem;
    }
    
    .card {
      padding: 0.5rem;
      gap: 0.5rem;
    }
    
    .progress {
      width: 32px;
      height: 32px;
      flex: 0 0 32px;
    }
    
    .progress svg {
      width: 32px;
      height: 32px;
    }
    
    .habit-actions {
      flex-direction: row;
      gap: 0.3rem;
    }
    
    .habit-actions .btn {
      width: auto;
      flex: 1;
    }
    
    .friend-card, .request-card {
      padding: 0.5rem;
      gap: 0.5rem;
    }
    
    .friend-avatar, .request-avatar {
      width: 32px;
      height: 32px;
      flex: 0 0 32px;
      font-size: 0.7rem;
    }
    
    .friend-actions, .request-actions {
      flex-direction: row;
      gap: 0.3rem;
    }
    
    .friend-actions .btn, .request-actions .btn {
      width: auto;
      flex: 1;
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg, var(--surface), var(--bg));
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.1);
      z-index: 100;
      padding: 0.4rem;
    }
    
    .modal {
      margin: 0.5rem;
      max-height: 85vh;
    }
    
    .modal-backdrop {
      padding: 0.5rem;
      align-items: flex-end;
    }
    
    .message {
      max-width: 90%;
    }
    
    .section-title {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }
    
    .section-title .btn {
      width: 100%;
    }
    
    .fab.habit-fab {
      bottom: 4.5rem;
      right: 0.75rem;
      width: 44px;
      height: 44px;
      font-size: 0.9rem;
    }
  }

  .btn, .nav-item, .icon-btn {
    min-height: 36px;
    min-width: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  html {
    -webkit-text-size-adjust: 100%;
    text-size-adjust: 100%;
  }

  body {
    -webkit-overflow-scrolling: touch;
    overflow-x: hidden;
  }

  button, .btn, .nav-item, .icon-btn {
    -webkit-tap-highlight-color: transparent;
  }

  button:focus-visible, 
  .btn:focus-visible, 
  .nav-item:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  .modal-backdrop {
    align-items: flex-end;
  }

  @media (max-height: 600px) {
    .modal {
      max-height: 90vh;
    }
  }
</style>
</head>
<body>
  <!-- Loading State -->
  <div class="loading" id="loadingState">
    <div class="logo">FF</div>
    <h2>Loading FocusForge...</h2>
    <p id="loadingText">Please wait while we check your authentication</p>
  </div>

  <!-- Username Setup Modal -->
  <div class="modal-backdrop" id="usernameModal">
    <div class="modal">
      <h3 style="margin-bottom:1.5rem;">Choose Your Username</h3>
      <div class="form-row">
        <label for="usernameInput">Username</label>
        <input id="usernameInput" placeholder="e.g., john_doe" maxlength="20" />
        <div class="small-muted">3-20 characters (letters, numbers, underscore only)</div>
      </div>
      <div class="actions">
        <button class="btn-modal" id="saveUsername">Save Username</button>
      </div>
    </div>
  </div>

  <!-- Account Details Modal -->
  <div class="modal-backdrop" id="accountModal">
    <div class="modal account-modal">
      <div class="modal-header">
        <h3>Account Details</h3>
        <button class="ghost" id="closeAccountModal">Close</button>
      </div>
      
      <div class="account-info">
        <div class="account-field">
          <div class="account-label">Username</div>
          <div class="username-display">
            <span class="account-value" id="accountUsername">username</span>
            <button class="ghost" id="editUsernameBtn" style="margin-left:0.5rem;padding:0.25rem 0.5rem;font-size:0.8rem;">
              <i class="fa-solid fa-pen"></i>
            </button>
          </div>
          <div class="edit-username">
            <input type="text" id="usernameInputEdit" maxlength="20" />
            <button class="btn-success" id="saveUsernameBtn" style="padding:0.5rem;">
              <i class="fa-solid fa-check"></i>
            </button>
            <button class="ghost" id="cancelEditUsername" style="padding:0.5rem;">
              <i class="fa-solid fa-times"></i>
            </button>
          </div>
        </div>
        
        <div class="account-field">
          <div class="account-label">Email</div>
          <div class="account-value" id="accountEmail">user@email.com</div>
        </div>
        
        <div class="account-field">
          <div class="account-label">Member Since</div>
          <div class="account-value" id="accountCreated">Recently</div>
        </div>
      </div>
      
      <div class="actions">
        <button class="ghost" id="signOutAccountBtn">
          <i class="fa-solid fa-right-from-bracket"></i> Sign Out
        </button>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div class="app" id="mainApp" style="display: none;">
    <header class="app-header">
      <div class="title" style="display:flex;gap:0.75rem;align-items:center">
        <div class="logo">FF</div>
        <div>
          <h1>FocusForge</h1>
          <div class="sub">Habits ‚Ä¢ Friends ‚Ä¢ Status</div>
        </div>
      </div>
      <div class="header-actions">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar" title="Account Details">U</div>
        </div>
        <div class="icon-btn" id="refreshBtn" title="Refresh"><i class="fa-solid fa-rotate"></i></div>
        <div class="icon-btn" id="signOutBtn" title="Sign Out"><i class="fa-solid fa-right-from-bracket"></i></div>
      </div>
    </header>

    <div class="main">
      <div class="content">
        <!-- Habits Section -->
        <section id="habitsSection" class="app-section active">
          <div class="section-title">
            <div>
              <h2>Habits</h2>
              <div class="small-muted">Daily check-ins & 30-day history</div>
            </div>
            <div class="chip" id="statsChip">0 habits ‚Ä¢ 0 today</div>
          </div>
          <div id="grid" class="grid"></div>
          <div id="emptyState" class="empty">
            <i class="fa-solid fa-list-check"></i>
            <div style="font-size:1.1rem;margin-bottom:0.4rem;font-weight:600">No habits yet</div>
            <div>Create your first habit ‚Äî press + button below</div>
          </div>
        </section>

        <!-- Friends Section -->
        <section id="friendsSection" class="app-section">
          <div class="section-title">
            <div>
              <h2>Friends</h2>
              <div class="small-muted">Connect and chat with friends</div>
            </div>
            <button class="btn btn-mark" id="openAddFriend">
              <i class="fa-solid fa-user-plus"></i> Add Friend
            </button>
          </div>

          <div class="requests-container">
            <div class="requests-title">Friend Requests</div>
            <div class="requests-list"></div>
          </div>

          <div>
            <h3 style="margin-bottom:0.75rem;font-size:0.9rem;">Your Friends</h3>
            <div class="friends-list"></div>
          </div>
        </section>

        <!-- Status Section -->
        <section id="statusSection" class="app-section">
          <div class="section-title">
            <div>
              <h2>Status</h2>
              <div class="small-muted">Updates from your friends</div>
            </div>
            <button class="btn btn-mark" id="openStatusModal">
              <i class="fa-solid fa-pen"></i> Post Update
            </button>
          </div>
          <div class="feed"></div>
        </section>
      </div>
    </div>

    <footer class="app-footer">
      <div>Made with ‚ù§Ô∏è</div>
      <div class="small-muted" id="usernameFooter">@<span id="navUsername">username</span></div>
    </footer>

    <nav>
      <div class="bottom-nav">
        <div class="nav-item active" data-target="habitsSection"><i class="fa-solid fa-list-check"></i><span>Habits</span></div>
        <div class="nav-item" data-target="friendsSection"><i class="fa-solid fa-user-friends"></i><span>Friends</span></div>
        <div class="nav-item" data-target="statusSection"><i class="fa-solid fa-circle-plus"></i><span>Status</span></div>
      </div>
    </nav>
  </div>

  <!-- FAB for Habits (Only visible in Habits section) -->
  <button class="fab habit-fab" id="openAdd" title="Add habit" style="display: none;"><i class="fa-solid fa-plus"></i></button>

  <!-- Habit Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle" style="margin-bottom:1.5rem;">Add Habit</h3>
      <div class="form-row">
        <label for="habitName">Habit Name</label>
        <input id="habitName" placeholder="e.g., Morning run" maxlength="80" />
      </div>
      <div class="form-row">
        <label for="habitNote">Note (Optional)</label>
        <input id="habitNote" placeholder="Short description" maxlength="120" />
      </div>
      <div class="form-row">
        <label for="habitColor">Color Theme</label>
        <select id="habitColor">
          <option value="#60a5fa">Blue</option>
          <option value="#f97316">Orange</option>
          <option value="#34d399">Green</option>
          <option value="#f472b6">Pink</option>
          <option value="#7c3aed">Purple</option>
        </select>
      </div>
      <div class="actions">
        <button class="ghost" id="cancelModal">Cancel</button>
        <button class="btn-modal" id="saveHabit">Save Habit</button>
      </div>
    </div>
  </div>

  <!-- Add Friend Modal -->
  <div class="modal-backdrop" id="addFriendModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Add Friend</h3>
        <button class="ghost" id="closeAddFriend">Close</button>
      </div>
      <div class="form-row">
        <label for="searchFriendInput">Search by Username</label>
        <div style="display:flex;gap:0.5rem;">
          <input id="searchFriendInput" placeholder="Enter username..." />
          <button class="btn btn-mark" id="searchFriendBtn">Search</button>
        </div>
      </div>
      <div id="searchResults" style="min-height:100px;margin-top:1rem;"></div>
    </div>
  </div>

  <!-- Chat Modal -->
  <div class="modal-backdrop" id="chatModal">
    <div class="modal chat-modal">
      <div class="modal-header">
        <h3 id="currentChatTitle">Chat</h3>
        <button class="ghost" id="closeChatModal">Close</button>
      </div>
      <div class="messages-container" id="messagesContainer"></div>
      <div class="chat-input-container">
        <input type="text" class="chat-input" id="messageInput" placeholder="Type a message..." />
        <button class="send-btn" id="sendMessageBtn">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Status Modal -->
  <div class="modal-backdrop" id="statusModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Post Status Update</h3>
        <button class="ghost" id="closeStatusModal">Close</button>
      </div>
      <div class="form-row">
        <label for="statusInput">What's on your mind?</label>
        <textarea id="statusInput" placeholder="Share your progress, motivation, or ask for advice..." rows="4" maxlength="280"></textarea>
        <div class="small-muted" style="text-align:right">Max 280 characters</div>
      </div>
      <div class="actions">
        <button class="ghost" id="closeStatusModal2">Cancel</button>
        <button class="btn-modal" id="postStatusBtn">Post Update</button>
      </div>
    </div>
  </div>

  <!-- More Menu -->
  <div class="more-menu" id="moreMenu">
    <button id="editBtn"><i class="fa-solid fa-pen-to-square"></i> Edit</button>
    <button id="deleteBtn"><i class="fa-solid fa-trash"></i> Delete</button>
  </div>

<script type="module">
  // ===== FIREBASE SETUP =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { 
    getAuth, 
    onAuthStateChanged, 
    signOut 
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { 
    getFirestore, 
    collection, 
    addDoc, 
    onSnapshot, 
    query, 
    orderBy, 
    where, 
    serverTimestamp, 
    doc, 
    getDocs, 
    getDoc, 
    setDoc, 
    updateDoc, 
    deleteDoc,
    arrayUnion, 
    arrayRemove,
    writeBatch
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCewGquzK-puz3IJb09qlB-dhnxHR_zg-U",
    authDomain: "focusforge-75a71.firebaseapp.com",
    projectId: "focusforge-75a71",
    storageBucket: "focusforge-75a71.firebasestorage.app",
    messagingSenderId: "311763639454",
    appId: "1:311763639454:web:e6a54ac4b69288223bef8f",
    measurementId: "G-SP5SPXSP6Q"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let currentUsername = '';

  // ===== FIREBASE AUTH LISTENER =====
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      console.log('‚úÖ User authenticated:', user.email);
      
      try {
        await initializeUserProfile(user);
        
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('mainApp').style.display = 'flex';
        
        document.getElementById('userAvatar').textContent = currentUsername.charAt(0).toUpperCase();
        document.getElementById('navUsername').textContent = currentUsername;
        document.getElementById('accountUsername').textContent = currentUsername;
        document.getElementById('accountEmail').textContent = user.email;
        
        // Initialize all app sections
        initializeHabitApp(user);
        initializeFriendsApp(user);
        initializeStatusApp(user);
        
        setupAccountModal();
        
      } catch (error) {
        console.error('Error initializing app:', error);
        document.getElementById('loadingText').textContent = 'Error loading app. Please refresh.';
      }
    } else {
      document.getElementById('loadingText').textContent = 'Not signed in. Redirecting...';
      setTimeout(() => {
        window.location.href = 'signin.html';
      }, 1500);
    }
  });

  // ===== USER PROFILE SETUP =====
  async function initializeUserProfile(user) {
    const userRef = doc(db, 'users', user.uid);
    
    try {
      const userSnap = await getDoc(userRef);
      
      if (!userSnap.exists()) {
        console.log('üë§ New user detected');
        const usernameModal = document.getElementById('usernameModal');
        usernameModal.style.display = 'flex';
        
        document.getElementById('saveUsername').addEventListener('click', async () => {
          const username = document.getElementById('usernameInput').value.trim().toLowerCase();
          if (!username) {
            alert('Please enter a username');
            return;
          }
          
          if (!/^[a-z0-9_]{3,20}$/.test(username)) {
            alert('Username must be 3-20 characters (letters, numbers, underscore only)');
            return;
          }
          
          try {
            const usernameQuery = query(collection(db, 'users'), where('username', '==', username));
            const usernameSnap = await getDocs(usernameQuery);
            
            if (!usernameSnap.empty) {
              alert('Username already taken. Please choose another one.');
              return;
            }
            
            currentUsername = username;
            await setDoc(userRef, {
              email: user.email,
              username: username,
              displayName: username,
              createdAt: serverTimestamp(),
              friends: [],
              friendRequests: [],
              sentRequests: []
            });
            
            usernameModal.style.display = 'none';
            alert('Profile created! Reloading...');
            location.reload();
          } catch (error) {
            console.error('Error creating profile:', error);
            alert('Error creating profile: ' + error.message);
          }
        });
        
      } else {
        const userData = userSnap.data();
        currentUsername = userData.username || user.email.split('@')[0];
        console.log('üë§ Existing user loaded:', currentUsername);
      }
    } catch (error) {
      console.error('Error loading user profile:', error);
      currentUsername = user.email.split('@')[0];
    }
  }

  // ===== ACCOUNT MODAL =====
  function setupAccountModal() {
    const accountModal = document.getElementById('accountModal');
    const userAvatar = document.getElementById('userAvatar');
    const closeAccountModal = document.getElementById('closeAccountModal');
    const editUsernameBtn = document.getElementById('editUsernameBtn');
    const saveUsernameBtn = document.getElementById('saveUsernameBtn');
    const cancelEditUsername = document.getElementById('cancelEditUsername');
    const usernameInput = document.getElementById('usernameInputEdit');
    const usernameDisplay = document.getElementById('accountUsername');
    const signOutAccountBtn = document.getElementById('signOutAccountBtn');

    userAvatar.addEventListener('click', () => {
      accountModal.style.display = 'flex';
    });

    closeAccountModal.addEventListener('click', () => {
      accountModal.style.display = 'none';
      cancelEdit();
    });

    editUsernameBtn.addEventListener('click', () => {
      document.querySelector('.username-display').style.display = 'none';
      document.querySelector('.edit-username').style.display = 'flex';
      usernameInput.value = currentUsername;
      usernameInput.focus();
    });

    saveUsernameBtn.addEventListener('click', async () => {
      const newUsername = usernameInput.value.trim().toLowerCase();
      if (!newUsername) {
        alert('Please enter a username');
        return;
      }
      
      if (!/^[a-z0-9_]{3,20}$/.test(newUsername)) {
        alert('Username must be 3-20 characters (letters, numbers, underscore only)');
        return;
      }
      
      if (newUsername === currentUsername) {
        cancelEdit();
        return;
      }
      
      try {
        const usernameQuery = query(collection(db, 'users'), where('username', '==', newUsername));
        const usernameSnap = await getDocs(usernameQuery);
        
        if (!usernameSnap.empty) {
          alert('Username already taken. Please choose another one.');
          return;
        }
        
        const userRef = doc(db, 'users', currentUser.uid);
        await updateDoc(userRef, {
          username: newUsername,
          displayName: newUsername
        });
        
        currentUsername = newUsername;
        document.getElementById('userAvatar').textContent = newUsername.charAt(0).toUpperCase();
        document.getElementById('navUsername').textContent = newUsername;
        usernameDisplay.textContent = newUsername;
        
        cancelEdit();
        alert('Username updated successfully!');
      } catch (error) {
        console.error('Error updating username:', error);
        alert('Error updating username. Please try again.');
      }
    });

    cancelEditUsername.addEventListener('click', cancelEdit);

    signOutAccountBtn.addEventListener('click', async () => {
      if (confirm('Are you sure you want to sign out?')) {
        try {
          await signOut(auth);
          window.location.href = 'signin.html';
        } catch (error) {
          console.error('Error signing out:', error);
        }
      }
    });

    function cancelEdit() {
      document.querySelector('.username-display').style.display = 'flex';
      document.querySelector('.edit-username').style.display = 'none';
    }
  }

  // ===== SIGN OUT =====
  document.getElementById('signOutBtn').addEventListener('click', async () => {
    if (confirm('Are you sure you want to sign out?')) {
      try {
        await signOut(auth);
        window.location.href = 'signin.html';
      } catch (error) {
        console.error('Error signing out:', error);
      }
    }
  });

  // ===== WORKING FRIENDS APP (SINGLE LINE LAYOUT) =====
  function initializeFriendsApp(user) {
    console.log('üöÄ Starting Friends App');
    
    const friendsList = document.querySelector('.friends-list');
    const requestsList = document.querySelector('.requests-list');
    const addFriendModal = document.getElementById('addFriendModal');
    const openAddFriend = document.getElementById('openAddFriend');
    const closeAddFriend = document.getElementById('closeAddFriend');
    const searchFriendInput = document.getElementById('searchFriendInput');
    const searchFriendBtn = document.getElementById('searchFriendBtn');
    const searchResults = document.getElementById('searchResults');
    
    const currentUserId = user.uid;
    
    // 1. SEND FRIEND REQUEST
    async function sendFriendRequest(targetUserId) {
      console.log('üì§ Sending request to:', targetUserId);
      
      try {
        const currentUserRef = doc(db, 'users', currentUserId);
        const targetUserRef = doc(db, 'users', targetUserId);
        
        const batch = writeBatch(db);
        
        batch.update(currentUserRef, {
          sentRequests: arrayUnion(targetUserId)
        });
        
        batch.update(targetUserRef, {
          friendRequests: arrayUnion(currentUserId)
        });
        
        await batch.commit();
        
        alert('‚úÖ Friend request sent!');
        addFriendModal.style.display = 'none';
        loadFriendsData();
        
      } catch (error) {
        console.error('‚ùå Send error:', error);
        alert('Error: ' + error.message);
      }
    }
    
    // 2. ACCEPT REQUEST
    async function acceptFriendRequest(requesterId) {
      console.log('‚úÖ Accepting from:', requesterId);
      
      try {
        const batch = writeBatch(db);
        const currentRef = doc(db, 'users', currentUserId);
        const requesterRef = doc(db, 'users', requesterId);
        
        batch.update(currentRef, {
          friendRequests: arrayRemove(requesterId),
          friends: arrayUnion(requesterId)
        });
        
        batch.update(requesterRef, {
          sentRequests: arrayRemove(currentUserId),
          friends: arrayUnion(currentUserId)
        });
        
        await batch.commit();
        alert('‚úÖ Friend added!');
        loadFriendsData();
        
      } catch (error) {
        console.error('‚ùå Accept error:', error);
        alert('Error: ' + error.message);
      }
    }
    
    // 3. DECLINE REQUEST
    async function declineFriendRequest(requesterId) {
      try {
        const batch = writeBatch(db);
        const currentRef = doc(db, 'users', currentUserId);
        const requesterRef = doc(db, 'users', requesterId);
        
        batch.update(currentRef, {
          friendRequests: arrayRemove(requesterId)
        });
        
        batch.update(requesterRef, {
          sentRequests: arrayRemove(currentUserId)
        });
        
        await batch.commit();
        alert('Request declined');
        loadFriendsData();
        
      } catch (error) {
        console.error('Decline error:', error);
        alert('Error: ' + error.message);
      }
    }
    
    // 4. REMOVE FRIEND - FIXED VERSION
    async function removeFriend(friendId) {
      if (!confirm('Remove this friend?')) return;
      
      try {
        const batch = writeBatch(db);
        const currentRef = doc(db, 'users', currentUserId);
        const friendRef = doc(db, 'users', friendId);
        
        batch.update(currentRef, {
          friends: arrayRemove(friendId)
        });
        
        batch.update(friendRef, {
          friends: arrayRemove(currentUserId)
        });
        
        await batch.commit();
        alert('Friend removed');
        loadFriendsData();
        
      } catch (error) {
        console.error('Remove friend error:', error);
        alert('Error: ' + error.message);
      }
    }
    
    // 5. SEARCH USERS
    async function searchUsers() {
      const searchTerm = searchFriendInput.value.trim().toLowerCase();
      if (!searchTerm) {
        searchResults.innerHTML = '<div class="small-muted">Enter username</div>';
        return;
      }
      
      searchResults.innerHTML = '<div class="small-muted">Searching...</div>';
      
      try {
        const usersSnapshot = await getDocs(collection(db, 'users'));
        searchResults.innerHTML = '';
        
        let found = false;
        const seenUsers = new Set();
        
        const currentRef = doc(db, 'users', currentUserId);
        const currentSnap = await getDoc(currentRef);
        const currentData = currentSnap.data() || {};
        const friends = currentData.friends || [];
        const sent = currentData.sentRequests || [];
        const received = currentData.friendRequests || [];
        
        usersSnapshot.forEach((docSnap) => {
          const userId = docSnap.id;
          const userData = docSnap.data();
          
          if (userId === currentUserId) return;
          if (!userData.username) return;
          if (seenUsers.has(userId)) return;
          seenUsers.add(userId);
          
          if (userData.username.toLowerCase().includes(searchTerm)) {
            found = true;
            
            let btnHtml = '';
            const isFriend = friends.includes(userId);
            const requestSent = sent.includes(userId);
            const requestReceived = received.includes(userId);
            
            if (isFriend) {
              btnHtml = '<button class="btn" disabled><i class="fa-solid fa-check"></i> Friends</button>';
            } else if (requestSent) {
              btnHtml = '<button class="btn" disabled><i class="fa-solid fa-clock"></i> Request Sent</button>';
            } else if (requestReceived) {
              btnHtml = `<button class="btn btn-success" data-id="${userId}"><i class="fa-solid fa-check"></i> Accept</button>`;
            } else {
              btnHtml = `<button class="btn btn-mark" data-id="${userId}"><i class="fa-solid fa-user-plus"></i> Add</button>`;
            }
            
            const item = document.createElement('div');
            item.className = 'friend-card';
            item.innerHTML = `
              <div class="friend-avatar">${userData.username.charAt(0).toUpperCase()}</div>
              <div class="friend-meta">
                <div class="friend-name">@${userData.username}</div>
                <div class="friend-email">${userData.email || ''}</div>
                <div class="friend-status">${isFriend ? 'Friends' : requestSent ? 'Request sent' : requestReceived ? 'Request received' : 'Not connected'}</div>
              </div>
              <div class="friend-actions">
                ${btnHtml}
              </div>
            `;
            searchResults.appendChild(item);
            
            const addBtn = item.querySelector('.btn-mark');
            if (addBtn) {
              addBtn.addEventListener('click', function() {
                const targetId = this.getAttribute('data-id');
                if (targetId) {
                  sendFriendRequest(targetId);
                }
              });
            }
            
            const acceptBtn = item.querySelector('.btn-success');
            if (acceptBtn) {
              acceptBtn.addEventListener('click', function() {
                const requesterId = this.getAttribute('data-id');
                if (requesterId) {
                  acceptFriendRequest(requesterId);
                }
              });
            }
          }
        });
        
        if (!found) {
          searchResults.innerHTML = '<div class="small-muted">No users found</div>';
        }
        
      } catch (error) {
        console.error('Search error:', error);
        searchResults.innerHTML = '<div class="small-muted">Search failed</div>';
      }
    }
    
    // 6. LOAD FRIENDS DATA
    function loadFriendsData() {
      console.log('üì• Loading friends...');
      
      const userRef = doc(db, 'users', currentUserId);
      
      onSnapshot(userRef, async (snap) => {
        if (!snap.exists()) {
          console.log('‚ùå No user data found');
          return;
        }
        
        const data = snap.data();
        console.log('üìä Friends:', data.friends?.length || 0, 'Requests:', data.friendRequests?.length || 0);
        
        renderFriends(data.friends || []);
        renderRequests(data.friendRequests || []);
        
      }, (error) => {
        console.error('‚ùå Load error:', error);
        friendsList.innerHTML = '<div class="small-muted">Error loading friends</div>';
      });
    }
    
    // 7. RENDER FRIENDS (SINGLE LINE) - FIXED EVENT LISTENER
    async function renderFriends(friendIds) {
      friendsList.innerHTML = '';
      
      if (!friendIds || friendIds.length === 0) {
        friendsList.innerHTML = `
          <div class="empty-friends">
            <i class="fa-solid fa-user-plus"></i>
            <div style="font-size:1.1rem;margin-bottom:0.5rem;font-weight:600">No friends yet</div>
            <div>Add friends to start chatting!</div>
          </div>
        `;
        return;
      }
      
      for (const friendId of friendIds) {
        try {
          const friendSnap = await getDoc(doc(db, 'users', friendId));
          if (friendSnap.exists()) {
            const friend = friendSnap.data();
            const item = document.createElement('div');
            item.className = 'friend-card';
            item.innerHTML = `
              <div class="friend-avatar">${friend.username?.charAt(0).toUpperCase() || 'F'}</div>
              <div class="friend-meta">
                <div class="friend-name">@${friend.username || 'user'}</div>
                <div class="friend-email">${friend.email || ''}</div>
                <div class="friend-status">Friends</div>
              </div>
              <div class="friend-actions">
                <button class="btn-chat" onclick="alert('Chat coming soon!')">
                  <i class="fa-solid fa-message"></i> Chat
                </button>
                <button class="btn-remove" data-id="${friendId}" title="Remove friend">
                  <i class="fa-solid fa-user-minus"></i>
                </button>
              </div>
            `;
            friendsList.appendChild(item);
            
            // FIXED: Add remove friend functionality with proper event delegation
            const removeBtn = item.querySelector('.btn-remove');
            if (removeBtn) {
              removeBtn.addEventListener('click', function() {
                // Get the friendId from the button's data attribute
                const friendId = this.getAttribute('data-id');
                if (friendId) {
                  removeFriend(friendId);
                }
              });
            }
          }
        } catch (error) {
          console.error('Error loading friend:', error);
        }
      }
    }
    
    // 8. RENDER REQUESTS (SINGLE LINE) - FIXED EVENT LISTENER
    async function renderRequests(requestIds) {
      requestsList.innerHTML = '';
      
      if (!requestIds || requestIds.length === 0) {
        requestsList.innerHTML = '<div class="small-muted" style="padding: 0.5rem;">No pending requests</div>';
        return;
      }
      
      for (const requesterId of requestIds) {
        try {
          const requesterSnap = await getDoc(doc(db, 'users', requesterId));
          if (requesterSnap.exists()) {
            const requester = requesterSnap.data();
            const item = document.createElement('div');
            item.className = 'request-card';
            item.innerHTML = `
              <div class="request-avatar">${requester.username?.charAt(0).toUpperCase() || 'U'}</div>
              <div class="request-meta">
                <div class="request-name">@${requester.username || 'user'}</div>
                <div class="request-text">Wants to be friends</div>
                <div class="friend-status">Pending</div>
              </div>
              <div class="request-actions">
                <button class="btn-success-small" data-id="${requesterId}">
                  <i class="fa-solid fa-check"></i> Accept
                </button>
                <button class="btn-danger-small" data-id="${requesterId}">
                  <i class="fa-solid fa-times"></i> Decline
                </button>
              </div>
            `;
            requestsList.appendChild(item);
            
            // FIXED: Use 'this' to get the correct element
            item.querySelector('.btn-success-small').addEventListener('click', function() {
              const requesterId = this.getAttribute('data-id');
              if (requesterId) {
                acceptFriendRequest(requesterId);
              }
            });
            
            item.querySelector('.btn-danger-small').addEventListener('click', function() {
              const requesterId = this.getAttribute('data-id');
              if (requesterId) {
                declineFriendRequest(requesterId);
              }
            });
          }
        } catch (error) {
          console.error('Error loading request:', error);
        }
      }
    }
    
    // EVENT LISTENERS
    openAddFriend.addEventListener('click', () => {
      addFriendModal.style.display = 'flex';
      searchFriendInput.value = '';
      searchResults.innerHTML = '<div class="small-muted">Search for users</div>';
      setTimeout(() => searchFriendInput.focus(), 100);
    });
    
    closeAddFriend.addEventListener('click', () => {
      addFriendModal.style.display = 'none';
    });
    
    searchFriendBtn.addEventListener('click', searchUsers);
    searchFriendInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') searchUsers();
    });
    
    // START
    loadFriendsData();
  }

  // ===== STATUS APP =====
  function initializeStatusApp(user) {
    const statusFeed = document.querySelector('.feed');
    const openStatusModal = document.getElementById('openStatusModal');
    const statusModal = document.getElementById('statusModal');
    const closeStatusModal = document.getElementById('closeStatusModal');
    const postStatusBtn = document.getElementById('postStatusBtn');
    const statusInput = document.getElementById('statusInput');

    // Load status updates
    function loadStatusUpdates() {
      const userRef = doc(db, 'users', user.uid);
      
      onSnapshot(userRef, async (docSnap) => {
        if (docSnap.exists()) {
          const userData = docSnap.data();
          const friendIds = userData.friends || [];
          
          if (friendIds.length === 0) {
            statusFeed.innerHTML = `
              <div class="empty-status">
                <i class="fa-solid fa-comment"></i>
                <div style="font-size:1.1rem;margin-bottom:0.5rem;font-weight:600">No updates from friends</div>
                <div>When your friends post updates, they'll appear here!</div>
              </div>
            `;
            return;
          }

          const statusPromises = friendIds.map(async (friendId) => {
            try {
              const statusQuery = query(
                collection(db, 'users', friendId, 'statuses'),
                orderBy('timestamp', 'desc')
              );
              const statusSnap = await getDocs(statusQuery);
              return statusSnap.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                userId: friendId
              }));
            } catch (error) {
              console.error('Error loading statuses:', error);
              return [];
            }
          });

          const allStatuses = (await Promise.all(statusPromises)).flat();
          allStatuses.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
          
          renderStatusFeed(allStatuses);
        }
      });
    }

    // Render status feed
    async function renderStatusFeed(statuses) {
      statusFeed.innerHTML = '';
      
      if (statuses.length === 0) {
        statusFeed.innerHTML = `
          <div class="empty-status">
            <i class="fa-solid fa-comment"></i>
            <div style="font-size:1.1rem;margin-bottom:0.5rem;font-weight:600">No updates yet</div>
            <div>Be the first to post an update!</div>
          </div>
        `;
        return;
      }

      for (const status of statuses) {
        try {
          const friendRef = doc(db, 'users', status.userId);
          const friendSnap = await getDoc(friendRef);
          
          if (friendSnap.exists()) {
            const friend = friendSnap.data();
            const statusEl = document.createElement('div');
            statusEl.className = 'post';
            statusEl.innerHTML = `
              <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
                <div class="user-avatar-small">${friend.username?.charAt(0).toUpperCase() || 'U'}</div>
                <div>
                  <h4>@${friend.username || 'user'}</h4>
                  <div class="small-muted">${getTimeAgo(status.timestamp?.toDate())}</div>
                </div>
              </div>
              <div class="status-text">${escapeHtml(status.text)}</div>
            `;
            statusFeed.appendChild(statusEl);
          }
        } catch (error) {
          console.error('Error rendering status:', error);
        }
      }
    }

    // Post status
    async function postStatus() {
      const text = statusInput.value.trim();
      if (!text) {
        alert('Please enter a status update');
        return;
      }

      try {
        await addDoc(collection(db, 'users', user.uid, 'statuses'), {
          text: text,
          timestamp: serverTimestamp()
        });
        statusInput.value = '';
        statusModal.style.display = 'none';
      } catch (error) {
        console.error('Error posting status:', error);
        alert('Error posting status. Please try again.');
      }
    }

    // Helper
    function getTimeAgo(date) {
      if (!date) return '';
      const now = new Date();
      const diff = now - date;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor(diff / (1000 * 60));
      
      if (hours > 0) return `${hours}h ago`;
      if (minutes > 0) return `${minutes}m ago`;
      return 'Just now';
    }

    // Event listeners
    openStatusModal.addEventListener('click', () => statusModal.style.display = 'flex');
    closeStatusModal.addEventListener('click', () => statusModal.style.display = 'none');
    postStatusBtn.addEventListener('click', postStatus);

    // Start
    loadStatusUpdates();
  }

  // ===== HABIT APP (FIRESTORE VERSION - CROSS-DEVICE SYNC) =====
  function initializeHabitApp(user) {
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const userId = user.uid;
    const habitsRef = collection(db, 'users', userId, 'habits');
    const habitFab = document.getElementById('openAdd');
    const usernameFooter = document.getElementById('usernameFooter');

    function todayStr(){ return new Date().toISOString().slice(0,10); }
    function isoFromDateObj(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10); }
    function addDays(dateStr, n){ const d = new Date(dateStr); d.setDate(d.getDate() + n); return isoFromDateObj(d); }

    function computeStreak(history, refDate=null){
      const today = refDate || todayStr();
      const set = new Set(history || []);
      let streak = 0;
      let cursor = today;
      while(set.has(cursor)){
        streak++;
        cursor = addDays(cursor, -1);
      }
      return streak;
    }

    const grid = $('#grid');
    const emptyState = $('#emptyState');
    const statsChip = $('#statsChip');

    function updateStatsDisplay(habits){
      const total = habits.length;
      const completedToday = habits.filter(h => (h.history||[]).includes(todayStr())).length;
      statsChip.textContent = `${total} habit${total!==1?'s':''} ‚Ä¢ ${completedToday} today`;
    }

    let unsubscribeHabits = null;

    function render(){
      if (!unsubscribeHabits) {
        const q = query(habitsRef, orderBy('createdAt', 'desc'));
        unsubscribeHabits = onSnapshot(q, (snapshot) => {
          const habits = [];
          snapshot.forEach((doc) => {
            habits.push({
              id: doc.id,
              ...doc.data()
            });
          });
          
          if(habits.length === 0){ 
            emptyState.style.display = 'block'; 
            grid.innerHTML = '';
          } else { 
            emptyState.style.display = 'none'; 
          }

          grid.innerHTML = '';
          
          habits.forEach(h => {
            const streak = computeStreak(h.history);
            const pct = Math.min(100, streak);
            const doneToday = (h.history || []).includes(todayStr());
            const size = 36, stroke = 4, radius = (size - stroke)/2;
            const circumference = 2*Math.PI*radius;
            const offset = circumference * (1 - pct/100);

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
              <div class="progress" title="${streak} day streak">
                <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
                  <defs>
                    <linearGradient id="g${h.id}" x1="0" y1="0" x2="1" y2="1">
                      <stop offset="0%" stop-color="${h.color}"></stop>
                      <stop offset="100%" stop-color="${h.color}"></stop>
                    </linearGradient>
                  </defs>
                  <circle cx="${size/2}" cy="${size/2}" r="${radius}" stroke="rgba(255,255,255,0.03)" stroke-width="${stroke}" fill="none"></circle>
                  <circle cx="${size/2}" cy="${size/2}" r="${radius}" stroke="url(#g${h.id})" stroke-width="${stroke}" stroke-linecap="round"
                    stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" fill="none" style="transition: stroke-dashoffset 450ms cubic-bezier(.2,.9,.3,1)"></circle>
                </svg>
                <div class="center">
                  <div style="font-weight:800">${streak}</div>
                  <div style="font-size:8px;color:var(--muted)">days</div>
                </div>
              </div>
              <div class="meta">
                <div class="habit-name" title="${escapeHtml(h.name)}">${escapeHtml(h.name)}</div>
                <div class="habit-note">${escapeHtml(h.note || '')}</div>
                <div class="habit-meta-row">
                  <div class="chip">üî• ${streak} streak</div>
                  <div class="chip">${h.history?.length || 0} total</div>
                </div>
              </div>
              <div class="habit-actions">
                <button class="btn ${doneToday ? '' : 'btn-mark'} mark-btn" data-id="${h.id}">${doneToday ? '<i class="fa-solid fa-check"></i> Done' : '<i class="fa-solid fa-circle"></i> Mark'}</button>
                <button class="btn btn-more" data-more="${h.id}"><i class="fa-solid fa-ellipsis-vertical"></i></button>
              </div>
            `;

            grid.appendChild(card);

            card.querySelector('.mark-btn').addEventListener('click', () => toggleToday(h.id));
            card.querySelector('[data-more]').addEventListener('click', (e) => openMoreMenu(e, h.id));
          });

          updateStatsDisplay(habits);
        }, (error) => {
          console.error('Error loading habits:', error);
          emptyState.style.display = 'block';
          emptyState.innerHTML = `
            <i class="fa-solid fa-wifi-slash"></i>
            <div style="font-size:1.1rem;margin-bottom:0.4rem;font-weight:600">Connection Error</div>
            <div>Could not load habits. Please check your connection.</div>
          `;
        });
      }
    }

    function uniqueSorted(arr){
      return Array.from(new Set(arr || [])).sort();
    }

    async function toggleToday(habitId){
      const habitRef = doc(db, 'users', userId, 'habits', habitId);
      
      try {
        const habitSnap = await getDoc(habitRef);
        
        if (!habitSnap.exists()) return;
        
        const habit = habitSnap.data();
        const today = todayStr();
        const history = uniqueSorted(habit.history || []);
        const pos = history.indexOf(today);
        
        if(pos !== -1){
          if(!confirm('Unmark completion for today?')) return;
          history.splice(pos,1);
        } else {
          history.push(today);
        }
        
        await updateDoc(habitRef, {
          history: uniqueSorted(history),
          updatedAt: serverTimestamp()
        });
      } catch (error) {
        console.error('Error toggling habit:', error);
        alert('Error updating habit. Please try again.');
      }
    }

    const modalBackdrop = $('#modalBackdrop');
    const modalTitle = $('#modalTitle');
    const habitName = $('#habitName');
    const habitNote = $('#habitNote');
    const habitColor = $('#habitColor');
    let editingId = null;

    $('#openAdd').addEventListener('click', ()=> openAddModal());
    $('#saveHabit').addEventListener('click', saveModalHabit);
    $('#cancelModal').addEventListener('click', ()=> { modalBackdrop.style.display='none'; editingId=null; });

    function openAddModal(){
      editingId = null;
      modalTitle.textContent = 'Add Habit';
      habitName.value = '';
      habitNote.value = '';
      habitColor.value = '#60a5fa';
      modalBackdrop.style.display = 'flex';
      setTimeout(() => habitName.focus(), 100);
    }

    function openEditModal(h){
      editingId = h.id;
      modalTitle.textContent = 'Edit Habit';
      habitName.value = h.name;
      habitNote.value = h.note || '';
      habitColor.value = h.color || '#60a5fa';
      modalBackdrop.style.display = 'flex';
      setTimeout(() => habitName.focus(), 100);
    }

    async function saveModalHabit(){
      const name = habitName.value.trim();
      if(!name){ alert('Enter habit name'); return; }
      const note = habitNote.value.trim();
      const color = habitColor.value || '#60a5fa';

      try {
        if(editingId){
          // Update existing habit
          const habitRef = doc(db, 'users', userId, 'habits', editingId);
          await updateDoc(habitRef, {
            name,
            note,
            color,
            updatedAt: serverTimestamp()
          });
        } else {
          // Create new habit
          await addDoc(habitsRef, {
            name,
            note,
            color,
            history: [],
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
        }
        modalBackdrop.style.display = 'none';
        editingId = null;
      } catch (error) {
        console.error('Error saving habit:', error);
        alert('Error saving habit. Please try again.');
      }
    }

    const moreMenu = $('#moreMenu');
    let openMenuFor = null;

    function openMoreMenu(e, id){
      e.stopPropagation();
      openMenuFor = id;
      const rect = e.currentTarget.getBoundingClientRect();
      moreMenu.style.left = (rect.left - 100) + 'px';
      moreMenu.style.top = (rect.bottom + 5) + 'px';
      moreMenu.style.display = 'block';
    }
    document.addEventListener('click', (e) => { if(!moreMenu.contains(e.target)) moreMenu.style.display = 'none'; });

    $('#editBtn').addEventListener('click', async ()=>{
      moreMenu.style.display = 'none';
      if(!openMenuFor) return;
      
      try {
        const habitRef = doc(db, 'users', userId, 'habits', openMenuFor);
        const habitSnap = await getDoc(habitRef);
        if(!habitSnap.exists()) return;
        
        const h = { id: habitSnap.id, ...habitSnap.data() };
        openEditModal(h);
      } catch (error) {
        console.error('Error loading habit for edit:', error);
        alert('Error loading habit. Please try again.');
      }
    });
    
    $('#deleteBtn').addEventListener('click', async ()=>{
      moreMenu.style.display = 'none';
      if(!openMenuFor) return;
      
      if(!confirm('Delete this habit?')) return;
      
      try {
        const habitRef = doc(db, 'users', userId, 'habits', openMenuFor);
        await deleteDoc(habitRef);
      } catch (error) {
        console.error('Error deleting habit:', error);
        alert('Error deleting habit. Please try again.');
      }
    });

    const navItems = $$('.nav-item');
    const sections = $$('.app-section');
    
    navItems.forEach(item => {
      item.addEventListener('click', () => {
        navItems.forEach(n => n.classList.remove('active'));
        sections.forEach(s => s.classList.remove('active'));
        item.classList.add('active');
        
        const targetSection = document.getElementById(item.dataset.target);
        targetSection.classList.add('active');
        targetSection.scrollTop = 0;
        
        if (item.dataset.target === 'habitsSection') {
          habitFab.style.display = 'grid';
          usernameFooter.style.display = 'none';
        } else {
          habitFab.style.display = 'none';
          usernameFooter.style.display = 'block';
        }
      });
    });

    usernameFooter.style.display = 'none';
    habitFab.style.display = 'grid';

    $('#refreshBtn').addEventListener('click', () => {
      if (unsubscribeHabits) {
        unsubscribeHabits();
        unsubscribeHabits = null;
      }
      render();
    });

    function escapeHtml(s){ 
      const div = document.createElement('div');
      div.textContent = s || '';
      return div.innerHTML;
    }
    
    // Start rendering
    render();
  }

  // ===== MIGRATION FUNCTION (Optional) =====
  async function migrateLocalHabitsToFirestore(user) {
    // Only run if user wants to migrate
    const STORAGE_KEY = `focusforge_habits_${user.email.replace(/[^a-zA-Z0-9]/g, '_')}_v1`;
    const localHabits = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    
    if (localHabits.length > 0) {
      // Check if user already has habits in Firestore
      const habitsRef = collection(db, 'users', user.uid, 'habits');
      const habitsSnap = await getDocs(habitsRef);
      
      if (habitsSnap.empty) {
        // Only ask to migrate if Firestore is empty
        if (confirm('Would you like to migrate your local habits to cloud storage?')) {
          const batch = writeBatch(db);
          
          for (const habit of localHabits) {
            const habitDocRef = doc(habitsRef);
            batch.set(habitDocRef, {
              name: habit.name,
              note: habit.note || '',
              color: habit.color || '#60a5fa',
              history: habit.history || [],
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
          }
          
          try {
            await batch.commit();
            localStorage.removeItem(STORAGE_KEY);
            alert('Habits migrated successfully! They will now sync across devices.');
          } catch (error) {
            console.error('Migration error:', error);
            alert('Migration failed. Habits remain in local storage.');
          }
        }
      }
    }
  }
</script>
</body>
</html>
