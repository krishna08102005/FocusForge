<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>FocusForge — Habits & Friends</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root{
    --bg:#04102a;
    --surface:#071827;
    --muted:#94a3b8;
    --accent:#60a5fa;
    --accent-2:#7c3aed;
    --success:#34d399;
    --danger:#ef4444;
    --card:#0b1724;
    --radius:8px;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;}
  html,body{height:100%;background:linear-gradient(180deg,var(--bg),var(--surface));color:#e8f2ff;-webkit-font-smoothing:antialiased;}
  a{color:inherit}
  .app{min-height:100vh;display:flex;flex-direction:column;background:linear-gradient(180deg,var(--bg),var(--surface));}
  header.app-header{padding:0.75rem;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));gap:1rem;border-bottom:1px solid rgba(255,255,255,0.03);}
  .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#021025;flex-shrink:0;font-size:0.8rem;}
  .title h1{font-size:1.1rem;margin:0}
  .sub{font-size:0.7rem;color:var(--muted);margin-top:0.1rem;}
  .header-actions{display:flex;gap:0.4rem;align-items:center}
  .icon-btn{width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.02);cursor:pointer;color:var(--muted);flex-shrink:0;font-size:0.9rem;}
  
  .user-info{display:flex;align-items:center;gap:0.5rem;}
  .user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:600;color:#021025;font-size:0.9rem;cursor:pointer;transition:transform 0.2s ease;border:2px solid rgba(255,255,255,0.1);}
  .user-avatar:hover{transform:scale(1.05);}
  .user-text{display:none;}

  .account-modal {
    width: 100%;
    max-width: 400px;
  }
  
  .account-info {
    background: rgba(255,255,255,0.02);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(255,255,255,0.05);
  }
  
  .account-field {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  
  .account-field:last-child {
    border-bottom: none;
  }
  
  .account-label {
    color: var(--muted);
    font-size: 0.9rem;
  }
  
  .account-value {
    font-weight: 600;
    color: #e8f2ff;
  }
  
  .edit-username {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    display: none;
  }
  
  .edit-username input {
    flex: 1;
    padding: 0.5rem;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.05);
    color: #eaf3ff;
  }

  .main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
  .content{flex:1;padding:0.75rem;overflow-y:auto;}
  section.app-section{display:none;height:100%;}
  section.app-section.active{display:block;}
  .section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem;flex-wrap:wrap;gap:0.5rem;}
  .small-muted{font-size:0.7rem;color:var(--muted);}
  .grid{display:grid;gap:0.5rem;grid-template-columns:1fr;}
  
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
    border-radius:var(--radius);
    padding:0.6rem;
    display:flex;
    gap:0.6rem;
    align-items:center;
    border:1px solid rgba(255,255,255,0.03);
    position:relative;
    transition:transform 0.2s ease, box-shadow 0.2s ease;
    min-height: auto;
  }
  .card:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(2,6,23,0.4);}
  
  .progress{
    width:36px;
    height:36px;
    flex:0 0 36px;
    display:grid;
    place-items:center;
    position:relative;
  }
  .progress svg{
    transform:rotate(-90deg);
    width:36px;
    height:36px;
  }
  .progress .center{
    position:absolute;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    font-size:0.55rem;
    color:#e6eef8;
    line-height:1;
  }
  .progress .center div:first-child{
    font-weight:800;
    font-size:0.65rem;
  }
  
  .meta{flex:1;min-width:0;}
  .habit-name{
    font-weight:700;
    font-size:0.8rem;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    margin-bottom:0.1rem;
    line-height:1.2;
  }
  .habit-note{
    font-size:0.65rem;
    color:var(--muted);
    margin-bottom:0.3rem;
    line-height:1.2;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-clamp: 1;
  }
  .habit-meta-row{
    display:flex;
    gap:0.3rem;
    align-items:center;
    flex-wrap:wrap;
    margin-bottom:0.2rem;
  }
  .chip{
    font-size:0.6rem;
    padding:0.15rem 0.3rem;
    border-radius:6px;
    background:rgba(255,255,255,0.02);
    border:1px solid rgba(255,255,255,0.02);
    color:var(--muted);
  }
  .habit-actions{
    display:flex;
    gap:0.3rem;
    align-items:center;
    margin-top:0.3rem;
  }
  .btn{
    padding:0.3rem 0.5rem;
    border-radius:5px;
    border:none;
    cursor:pointer;
    font-weight:600;
    font-size:0.65rem;
    display:inline-flex;
    gap:0.15rem;
    align-items:center;
    justify-content:center;
    transition:all 0.2s ease;
    line-height:1;
  }
  .btn-mark{
    background:linear-gradient(90deg,var(--success),#10b981);
    color:#021;
    border:none;
  }
  .btn-more{
    background:transparent;
    border:1px solid rgba(255,255,255,0.03);
    color:var(--muted);
    padding:0.3rem;
    border-radius:5px;
    width:24px;
    height:24px;
  }
  
  .history{display:none !important;}
  
  .fab.habit-fab {
    position: fixed;
    right: 1rem;
    bottom: 5rem;
    z-index: 30;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: grid;
    place-items: center;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: #021025;
    font-size: 1rem;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
    border: none;
    transition: transform 0.2s ease;
    display: none;
  }
  .fab.habit-fab:hover{transform:scale(1.1);}
  
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.8);display:none;align-items:center;justify-content:center;z-index:40;padding:1rem;}
  .modal{width:100%;max-width:500px;background:linear-gradient(180deg,#061025,#07142a);border-radius:1rem;padding:1.25rem;border:1px solid rgba(255,255,255,0.03);color:#eaf3ff;max-height:90vh;overflow-y:auto;}
  .form-row{display:flex;flex-direction:column;gap:0.5rem;margin-bottom:1rem;}
  .form-row label{color:var(--muted);font-size:0.9rem;font-weight:500;}
  .form-row input,.form-row select,textarea{width:100%;padding:0.75rem;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:#eaf3ff;outline:none;font-size:1rem;transition:border-color 0.2s ease;}
  .form-row input:focus,.form-row select:focus{outline:none;border-color:var(--accent);}
  .form-row select option{background:#061025;color:#eaf3ff;padding:0.5rem;}
  .modal .actions{display:flex;gap:0.75rem;justify-content:flex-end;margin-top:1.5rem;}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--muted);padding:0.75rem 1.25rem;border-radius:8px;cursor:pointer;transition:all 0.2s ease;}
  .ghost:hover{background:rgba(255,255,255,0.05);}
  .btn-modal{background:linear-gradient(90deg,var(--success),#10b981);color:#021;border:none;padding:0.75rem 1.5rem;border-radius:8px;cursor:pointer;font-weight:600;transition:transform 0.2s ease;}
  .btn-modal:hover{transform:translateY(-1px);}
  .more-menu{position:absolute;background:#061025;border:1px solid rgba(255,255,255,0.1);padding:0.4rem;border-radius:6px;z-index:50;display:none;min-width:120px;box-shadow:0 4px 12px rgba(0,0,0,0.3);}
  .more-menu button{display:block;background:transparent;border:none;color:var(--muted);padding:0.5rem 0.75rem;width:100%;text-align:left;cursor:pointer;border-radius:4px;font-size:0.8rem;transition:all 0.2s ease;}
  .more-menu button:hover{background:rgba(255,255,255,0.05);color:#e6eef8}
  .bottom-nav{display:flex;justify-content:space-around;align-items:center;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-top:1px solid rgba(255,255,255,0.03);padding:0.5rem;gap:0.25rem;margin-top:auto;}
  .nav-item{text-align:center;flex:1;color:var(--muted);font-size:0.65rem;cursor:pointer;padding:0.4rem 0.2rem;display:flex;flex-direction:column;align-items:center;gap:0.2rem;transition:all 0.2s ease;border-radius:6px;}
  .nav-item:hover{background:rgba(255,255,255,0.02);}
  .nav-item.active{color:var(--accent);}
  .nav-item i{font-size:1rem;}
  .feed{display:flex;flex-direction:column;gap:0.75rem;}
  .post{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border-radius:10px;padding:0.75rem;border:1px solid rgba(255,255,255,0.02)}
  footer.app-footer{padding:0.75rem;border-top:1px solid rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:0.7rem;background:transparent;}
  .empty{text-align:center;padding:2rem 1rem;color:var(--muted);display:none;}
  .empty i{font-size:2rem;margin-bottom:0.75rem;opacity:0.5;}
  .empty div{font-size:0.9rem;}
  .loading{display:flex;justify-content:center;align-items:center;height:100vh;background:var(--bg);color:white;flex-direction:column;gap:1rem;}
  .loading .logo{width:50px;height:50px;font-size:1.2rem;}

  .friend-item, .request-item, .search-result-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.02);
    background: rgba(255,255,255,0.01);
    margin-bottom: 0.4rem;
    transition: all 0.2s ease;
  }

  .friend-item:hover, .search-result-item:hover {
    background: rgba(255,255,255,0.02);
    transform: translateY(-1px);
  }

  .friend-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: #021025;
    flex-shrink: 0;
    font-size: 0.8rem;
  }

  .friend-actions, .request-actions {
    display: flex;
    gap: 0.4rem;
  }

  .btn-chat {
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: #021025;
    border: none;
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.7rem;
  }

  .btn-success {
    background: var(--success);
    color: #021025;
    border: none;
    padding: 0.4rem;
    border-radius: 6px;
    font-size: 0.7rem;
  }

  .btn-danger {
    background: var(--danger);
    color: white;
    border: none;
    padding: 0.4rem;
    border-radius: 6px;
    font-size: 0.7rem;
  }

  .empty-friends, .empty-status {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--muted);
  }

  .empty-friends i, .empty-status i {
    font-size: 2rem;
    margin-bottom: 0.75rem;
    opacity: 0.5;
  }

  .requests-container {
    background: rgba(255,255,255,0.02);
    border-radius: 10px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
  }

  .requests-title {
    font-weight: 600;
    margin-bottom: 0.4rem;
    color: var(--accent);
    font-size: 0.8rem;
  }

  .user-avatar-small {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: #021025;
    font-size: 0.6rem;
    flex-shrink: 0;
  }

  .message {
    margin-bottom: 0.75rem;
    padding: 0.6rem;
    border-radius: 10px;
    max-width: 80%;
  }

  .own-message {
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    margin-left: auto;
    color: #021025;
  }

  .other-message {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
  }

  .message-text {
    font-size: 0.8rem;
    line-height: 1.3;
  }

  .message-time {
    font-size: 0.6rem;
    opacity: 0.7;
    margin-top: 0.2rem;
    text-align: right;
  }

  .status-text {
    font-size: 0.85rem;
    line-height: 1.3;
    color: #e8f2ff;
  }

  .chat-modal {
    width: 100%;
    max-width: 400px;
    height: 70vh;
    display: flex;
    flex-direction: column;
  }

  .messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
  }

  .chat-input-container {
    display: flex;
    gap: 0.4rem;
    padding: 0.75rem;
    border-top: 1px solid rgba(255,255,255,0.1);
  }

  .chat-input {
    flex: 1;
    padding: 0.6rem;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.05);
    color: #eaf3ff;
    outline: none;
    font-size: 0.8rem;
  }

  .send-btn {
    padding: 0.6rem 0.8rem;
    border-radius: 16px;
    border: none;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: #021025;
    cursor: pointer;
    font-size: 0.8rem;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  @media (max-width: 768px) {
    .content {
      padding: 0.5rem;
      padding-bottom: 5rem;
    }
    
    .grid {
      gap: 0.4rem;
    }
    
    .card {
      padding: 0.5rem;
      gap: 0.5rem;
    }
    
    .progress {
      width: 32px;
      height: 32px;
      flex: 0 0 32px;
    }
    
    .progress svg {
      width: 32px;
      height: 32px;
    }
    
    .habit-actions {
      flex-direction: row;
      gap: 0.3rem;
    }
    
    .habit-actions .btn {
      width: auto;
      flex: 1;
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg, var(--surface), var(--bg));
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.1);
      z-index: 100;
      padding: 0.4rem;
    }
    
    .modal {
      margin: 0.5rem;
      max-height: 85vh;
    }
    
    .modal-backdrop {
      padding: 0.5rem;
      align-items: flex-end;
    }
    
    .friend-item, .request-item, .search-result-item {
      flex-direction: column;
      text-align: center;
      gap: 0.5rem;
      padding: 0.6rem;
    }
    
    .friend-actions, .request-actions {
      justify-content: center;
      width: 100%;
    }
    
    .friend-actions .btn, .request-actions .btn {
      flex: 1;
    }
    
    .message {
      max-width: 90%;
    }
    
    .section-title {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }
    
    .section-title .btn {
      width: 100%;
    }
    
    .fab.habit-fab {
      bottom: 4.5rem;
      right: 0.75rem;
      width: 44px;
      height: 44px;
      font-size: 0.9rem;
    }
  }

  .btn, .nav-item, .icon-btn {
    min-height: 36px;
    min-width: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  html {
    -webkit-text-size-adjust: 100%;
    text-size-adjust: 100%;
  }

  body {
    -webkit-overflow-scrolling: touch;
    overflow-x: hidden;
  }

  button, .btn, .nav-item, .icon-btn {
    -webkit-tap-highlight-color: transparent;
  }

  button:focus-visible, 
  .btn:focus-visible, 
  .nav-item:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  .modal-backdrop {
    align-items: flex-end;
  }

  @media (max-height: 600px) {
    .modal {
      max-height: 90vh;
    }
  }
</style>
</head>
<body>
  <!-- Loading State -->
  <div class="loading" id="loadingState">
    <div class="logo">FF</div>
    <h2>Loading FocusForge...</h2>
    <p id="loadingText">Please wait while we check your authentication</p>
  </div>

  <!-- Username Setup Modal -->
  <div class="modal-backdrop" id="usernameModal">
    <div class="modal">
      <h3 style="margin-bottom:1.5rem;">Choose Your Username</h3>
      <div class="form-row">
        <label for="usernameInput">Username</label>
        <input id="usernameInput" placeholder="e.g., john_doe" maxlength="20" />
        <div class="small-muted">3-20 characters (letters, numbers, underscore only)</div>
      </div>
      <div class="actions">
        <button class="btn-modal" id="saveUsername">Save Username</button>
      </div>
    </div>
  </div>

  <!-- Account Details Modal -->
  <div class="modal-backdrop" id="accountModal">
    <div class="modal account-modal">
      <div class="modal-header">
        <h3>Account Details</h3>
        <button class="ghost" id="closeAccountModal">Close</button>
      </div>
      
      <div class="account-info">
        <div class="account-field">
          <div class="account-label">Username</div>
          <div class="username-display">
            <span class="account-value" id="accountUsername">username</span>
            <button class="ghost" id="editUsernameBtn" style="margin-left:0.5rem;padding:0.25rem 0.5rem;font-size:0.8rem;">
              <i class="fa-solid fa-pen"></i>
            </button>
          </div>
          <div class="edit-username">
            <input type="text" id="usernameInputEdit" maxlength="20" />
            <button class="btn-success" id="saveUsernameBtn" style="padding:0.5rem;">
              <i class="fa-solid fa-check"></i>
            </button>
            <button class="ghost" id="cancelEditUsername" style="padding:0.5rem;">
              <i class="fa-solid fa-times"></i>
            </button>
          </div>
        </div>
        
        <div class="account-field">
          <div class="account-label">Email</div>
          <div class="account-value" id="accountEmail">user@email.com</div>
        </div>
        
        <div class="account-field">
          <div class="account-label">Member Since</div>
          <div class="account-value" id="accountCreated">Recently</div>
        </div>
      </div>
      
      <div class="actions">
        <button class="ghost" id="signOutAccountBtn">
          <i class="fa-solid fa-right-from-bracket"></i> Sign Out
        </button>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div class="app" id="mainApp" style="display: none;">
    <header class="app-header">
      <div class="title" style="display:flex;gap:0.75rem;align-items:center">
        <div class="logo">FF</div>
        <div>
          <h1>FocusForge</h1>
          <div class="sub">Habits • Friends • Status</div>
        </div>
      </div>
      <div class="header-actions">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar" title="Account Details">U</div>
        </div>
        <div class="icon-btn" id="refreshBtn" title="Refresh"><i class="fa-solid fa-rotate"></i></div>
        <div class="icon-btn" id="signOutBtn" title="Sign Out"><i class="fa-solid fa-right-from-bracket"></i></div>
      </div>
    </header>

    <div class="main">
      <div class="content">
        <!-- Habits Section -->
        <section id="habitsSection" class="app-section active">
          <div class="section-title">
            <div>
              <h2>Habits</h2>
              <div class="small-muted">Daily check-ins & 30-day history</div>
            </div>
            <div class="chip" id="statsChip">0 habits • 0 today</div>
          </div>
          <div id="grid" class="grid"></div>
          <div id="emptyState" class="empty">
            <i class="fa-solid fa-list-check"></i>
            <div style="font-size:1.1rem;margin-bottom:0.4rem;font-weight:600">No habits yet</div>
            <div>Create your first habit — press + button below</div>
          </div>
        </section>

        <!-- Friends Section -->
        <section id="friendsSection" class="app-section">
          <div class="section-title">
            <div>
              <h2>Friends</h2>
              <div class="small-muted">Connect and chat with friends</div>
            </div>
            <button class="btn btn-mark" id="openAddFriend">
              <i class="fa-solid fa-user-plus"></i> Add Friend
            </button>
          </div>

          <div class="requests-container">
            <div class="requests-title">Friend Requests</div>
            <div class="requests-list"></div>
          </div>

          <div>
            <h3 style="margin-bottom:0.75rem;font-size:0.9rem;">Your Friends</h3>
            <div class="friends-list"></div>
          </div>
        </section>

        <!-- Status Section -->
        <section id="statusSection" class="app-section">
          <div class="section-title">
            <div>
              <h2>Status</h2>
              <div class="small-muted">Updates from your friends</div>
            </div>
            <button class="btn btn-mark" id="openStatusModal">
              <i class="fa-solid fa-pen"></i> Post Update
            </button>
          </div>
          <div class="feed"></div>
        </section>
      </div>
    </div>

    <footer class="app-footer">
      <div>Made with ❤️</div>
      <div class="small-muted" id="usernameFooter">@<span id="navUsername">username</span></div>
    </footer>

    <nav>
      <div class="bottom-nav">
        <div class="nav-item active" data-target="habitsSection"><i class="fa-solid fa-list-check"></i><span>Habits</span></div>
        <div class="nav-item" data-target="friendsSection"><i class="fa-solid fa-user-friends"></i><span>Friends</span></div>
        <div class="nav-item" data-target="statusSection"><i class="fa-solid fa-circle-plus"></i><span>Status</span></div>
      </div>
    </nav>
  </div>

  <!-- FAB for Habits (Only visible in Habits section) -->
  <button class="fab habit-fab" id="openAdd" title="Add habit" style="display: none;"><i class="fa-solid fa-plus"></i></button>

  <!-- Habit Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle" style="margin-bottom:1.5rem;">Add Habit</h3>
      <div class="form-row">
        <label for="habitName">Habit Name</label>
        <input id="habitName" placeholder="e.g., Morning run" maxlength="80" />
      </div>
      <div class="form-row">
        <label for="habitNote">Note (Optional)</label>
        <input id="habitNote" placeholder="Short description" maxlength="120" />
      </div>
      <div class="form-row">
        <label for="habitColor">Color Theme</label>
        <select id="habitColor">
          <option value="#60a5fa">Blue</option>
          <option value="#f97316">Orange</option>
          <option value="#34d399">Green</option>
          <option value="#f472b6">Pink</option>
          <option value="#7c3aed">Purple</option>
        </select>
      </div>
      <div class="actions">
        <button class="ghost" id="cancelModal">Cancel</button>
        <button class="btn-modal" id="saveHabit">Save Habit</button>
      </div>
    </div>
  </div>

  <!-- Add Friend Modal -->
  <div class="modal-backdrop" id="addFriendModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Add Friend</h3>
        <button class="ghost" id="closeAddFriend">Close</button>
      </div>
      <div class="form-row">
        <label for="searchFriendInput">Search by Username</label>
        <div style="display:flex;gap:0.5rem;">
          <input id="searchFriendInput" placeholder="Enter username..." />
          <button class="btn btn-mark" id="searchFriendBtn">Search</button>
        </div>
      </div>
      <div id="searchResults" style="min-height:100px;margin-top:1rem;"></div>
    </div>
  </div>

  <!-- Chat Modal -->
  <div class="modal-backdrop" id="chatModal">
    <div class="modal chat-modal">
      <div class="modal-header">
        <h3 id="currentChatTitle">Chat</h3>
        <button class="ghost" id="closeChatModal">Close</button>
      </div>
      <div class="messages-container" id="messagesContainer"></div>
      <div class="chat-input-container">
        <input type="text" class="chat-input" id="messageInput" placeholder="Type a message..." />
        <button class="send-btn" id="sendMessageBtn">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Status Modal -->
  <div class="modal-backdrop" id="statusModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Post Status Update</h3>
        <button class="ghost" id="closeStatusModal">Close</button>
      </div>
      <div class="form-row">
        <label for="statusInput">What's on your mind?</label>
        <textarea id="statusInput" placeholder="Share your progress, motivation, or ask for advice..." rows="4" maxlength="280"></textarea>
        <div class="small-muted" style="text-align:right">Max 280 characters</div>
      </div>
      <div class="actions">
        <button class="ghost" id="closeStatusModal2">Cancel</button>
        <button class="btn-modal" id="postStatusBtn">Post Update</button>
      </div>
    </div>
  </div>

  <!-- More Menu -->
  <div class="more-menu" id="moreMenu">
    <button id="editBtn"><i class="fa-solid fa-pen-to-square"></i> Edit</button>
    <button id="deleteBtn"><i class="fa-solid fa-trash"></i> Delete</button>
  </div>

<script type="module">
  // Import Firebase modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, doc, getDocs, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCewGquzK-puz3IJb09qlB-dhnxHR_zg-U",
    authDomain: "focusforge-75a71.firebaseapp.com",
    projectId: "focusforge-75a71",
    storageBucket: "focusforge-75a71.firebasestorage.app",
    messagingSenderId: "311763639454",
    appId: "1:311763639454:web:e6a54ac4b69288223bef8f",
    measurementId: "G-SP5SPXSP6Q"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let currentUsername = '';

  // Check authentication state
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      
      try {
        // Initialize or get user profile
        await initializeUserProfile(user);
        
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('mainApp').style.display = 'flex';
        
        // Update UI with user info
        document.getElementById('userAvatar').textContent = currentUsername.charAt(0).toUpperCase();
        document.getElementById('navUsername').textContent = currentUsername;
        document.getElementById('accountUsername').textContent = currentUsername;
        document.getElementById('accountEmail').textContent = user.email;
        
        // Initialize all apps
        initializeHabitApp(user.email);
        initializeFriendsApp(user);
        initializeStatusApp(user);
        
        // Setup account modal
        setupAccountModal();
      } catch (error) {
        console.error('Error initializing app:', error);
        document.getElementById('loadingText').textContent = 'Error loading app. Please refresh.';
      }
    } else {
      document.getElementById('loadingText').textContent = 'Not signed in. Redirecting...';
      setTimeout(() => {
        window.location.href = 'signin.html';
      }, 1500);
    }
  });

  // Setup account modal functionality
  function setupAccountModal() {
    const accountModal = document.getElementById('accountModal');
    const userAvatar = document.getElementById('userAvatar');
    const closeAccountModal = document.getElementById('closeAccountModal');
    const editUsernameBtn = document.getElementById('editUsernameBtn');
    const saveUsernameBtn = document.getElementById('saveUsernameBtn');
    const cancelEditUsername = document.getElementById('cancelEditUsername');
    const usernameInput = document.getElementById('usernameInputEdit');
    const usernameDisplay = document.getElementById('accountUsername');
    const signOutAccountBtn = document.getElementById('signOutAccountBtn');

    // Open account modal when clicking user avatar
    userAvatar.addEventListener('click', () => {
      accountModal.style.display = 'flex';
    });

    // Close account modal
    closeAccountModal.addEventListener('click', () => {
      accountModal.style.display = 'none';
      cancelEdit(); // Reset edit state
    });

    // Edit username
    editUsernameBtn.addEventListener('click', () => {
      document.querySelector('.username-display').style.display = 'none';
      document.querySelector('.edit-username').style.display = 'flex';
      usernameInput.value = currentUsername;
      usernameInput.focus();
    });

    // Save username
    saveUsernameBtn.addEventListener('click', async () => {
      const newUsername = usernameInput.value.trim().toLowerCase();
      if (!newUsername) {
        alert('Please enter a username');
        return;
      }
      
      if (!/^[a-z0-9_]{3,20}$/.test(newUsername)) {
        alert('Username must be 3-20 characters (letters, numbers, underscore only)');
        return;
      }
      
      if (newUsername === currentUsername) {
        cancelEdit();
        return;
      }
      
      try {
        // Check if username is available
        const usernameQuery = query(collection(db, 'users'), where('username', '==', newUsername));
        const usernameSnap = await getDocs(usernameQuery);
        
        if (!usernameSnap.empty) {
          alert('Username already taken. Please choose another one.');
          return;
        }
        
        // Update username in database
        const userRef = doc(db, 'users', currentUser.uid);
        await updateDoc(userRef, {
          username: newUsername,
          displayName: newUsername
        });
        
        // Update local state
        currentUsername = newUsername;
        document.getElementById('userAvatar').textContent = newUsername.charAt(0).toUpperCase();
        document.getElementById('navUsername').textContent = newUsername;
        usernameDisplay.textContent = newUsername;
        
        cancelEdit();
        alert('Username updated successfully!');
      } catch (error) {
        console.error('Error updating username:', error);
        alert('Error updating username. Please try again.');
      }
    });

    // Cancel edit
    cancelEditUsername.addEventListener('click', cancelEdit);

    // Sign out from account modal
    signOutAccountBtn.addEventListener('click', async () => {
      if (confirm('Are you sure you want to sign out?')) {
        try {
          await signOut(auth);
          window.location.href = 'signin.html';
        } catch (error) {
          console.error('Error signing out:', error);
        }
      }
    });

    function cancelEdit() {
      document.querySelector('.username-display').style.display = 'flex';
      document.querySelector('.edit-username').style.display = 'none';
    }
  }

  // Initialize user profile with username
  async function initializeUserProfile(user) {
    const userRef = doc(db, 'users', user.uid);
    
    try {
      const userSnap = await getDoc(userRef);
      
      if (!userSnap.exists()) {
        // New user - create profile with username
        const usernameModal = document.getElementById('usernameModal');
        usernameModal.style.display = 'flex';
        
        document.getElementById('saveUsername').addEventListener('click', async () => {
          const username = document.getElementById('usernameInput').value.trim().toLowerCase();
          if (!username) {
            alert('Please enter a username');
            return;
          }
          
          if (!/^[a-z0-9_]{3,20}$/.test(username)) {
            alert('Username must be 3-20 characters (letters, numbers, underscore only)');
            return;
          }
          
          try {
            // Check if username is available
            const usernameQuery = query(collection(db, 'users'), where('username', '==', username));
            const usernameSnap = await getDocs(usernameQuery);
            
            if (!usernameSnap.empty) {
              alert('Username already taken. Please choose another one.');
              return;
            }
            
            currentUsername = username;
            await setDoc(userRef, {
              email: user.email,
              username: username,
              displayName: username,
              createdAt: serverTimestamp(),
              friends: [],
              friendRequests: [],
              sentRequests: []
            });
            
            usernameModal.style.display = 'none';
            location.reload(); // Refresh to load everything with username
          } catch (error) {
            console.error('Error creating profile:', error);
            alert('Error creating profile. Please try again.');
          }
        });
        
      } else {
        // Existing user
        const userData = userSnap.data();
        currentUsername = userData.username || user.email.split('@')[0];
      }
    } catch (error) {
      console.error('Error loading user profile:', error);
      // Fallback: use email as username
      currentUsername = user.email.split('@')[0];
    }
  }

  // Sign out functionality (from header)
  document.getElementById('signOutBtn').addEventListener('click', async () => {
    if (confirm('Are you sure you want to sign out?')) {
      try {
        await signOut(auth);
        window.location.href = 'signin.html';
      } catch (error) {
        console.error('Error signing out:', error);
      }
    }
  });

  // ===== COMPLETELY REWRITTEN FRIENDS APP =====
  function initializeFriendsApp(user) {
    const friendsList = document.querySelector('.friends-list');
    const requestsList = document.querySelector('.requests-list');
    const addFriendModal = document.getElementById('addFriendModal');
    const openAddFriend = document.getElementById('openAddFriend');
    const closeAddFriend = document.getElementById('closeAddFriend');
    const searchFriendInput = document.getElementById('searchFriendInput');
    const searchFriendBtn = document.getElementById('searchFriendBtn');
    const searchResults = document.getElementById('searchResults');

    // SIMPLE FRIEND REQUEST FUNCTION
    async function sendFriendRequest(targetUserId) {
      try {
        console.log('Sending friend request to:', targetUserId);
        
        // Get target user data
        const targetUserRef = doc(db, 'users', targetUserId);
        const targetUserSnap = await getDoc(targetUserRef);
        
        if (!targetUserSnap.exists()) {
          alert('User not found');
          return;
        }
        
        const targetUserData = targetUserSnap.data();
        
        // Get current user data
        const currentUserRef = doc(db, 'users', user.uid);
        const currentUserSnap = await getDoc(currentUserRef);
        const currentUserData = currentUserSnap.data();
        
        // Check if already friends
        if (currentUserData.friends && currentUserData.friends.includes(targetUserId)) {
          alert('You are already friends with this user');
          return;
        }
        
        // Check if request already sent
        if (currentUserData.sentRequests && currentUserData.sentRequests.includes(targetUserId)) {
          alert('Friend request already sent');
          return;
        }
        
        // SIMPLE APPROACH: Just update the arrays directly
        const targetUserFriendRequests = targetUserData.friendRequests || [];
        const currentUserSentRequests = currentUserData.sentRequests || [];
        
        // Add to target user's friend requests
        await updateDoc(targetUserRef, {
          friendRequests: [...targetUserFriendRequests, user.uid]
        });
        
        // Add to current user's sent requests
        await updateDoc(currentUserRef, {
          sentRequests: [...currentUserSentRequests, targetUserId]
        });
        
        alert('Friend request sent successfully!');
        addFriendModal.style.display = 'none';
        
      } catch (error) {
        console.error('Error sending friend request:', error);
        alert('Error sending friend request: ' + error.message);
      }
    }

    // SIMPLE ACCEPT FRIEND REQUEST
    async function acceptFriendRequest(requesterId) {
      try {
        const currentUserRef = doc(db, 'users', user.uid);
        const requesterRef = doc(db, 'users', requesterId);
        
        // Get current data
        const currentUserSnap = await getDoc(currentUserRef);
        const requesterSnap = await getDoc(requesterRef);
        
        const currentUserData = currentUserSnap.data();
        const requesterData = requesterSnap.data();
        
        // Update both users
        await updateDoc(currentUserRef, {
          friends: [...(currentUserData.friends || []), requesterId],
          friendRequests: (currentUserData.friendRequests || []).filter(id => id !== requesterId)
        });
        
        await updateDoc(requesterRef, {
          friends: [...(requesterData.friends || []), user.uid],
          sentRequests: (requesterData.sentRequests || []).filter(id => id !== user.uid)
        });
        
        alert('Friend request accepted!');
        
      } catch (error) {
        console.error('Error accepting friend request:', error);
        alert('Error accepting friend request');
      }
    }

    // SIMPLE DECLINE FRIEND REQUEST
    async function declineFriendRequest(requesterId) {
      try {
        const currentUserRef = doc(db, 'users', user.uid);
        const currentUserSnap = await getDoc(currentUserRef);
        const currentUserData = currentUserSnap.data();
        
        await updateDoc(currentUserRef, {
          friendRequests: (currentUserData.friendRequests || []).filter(id => id !== requesterId)
        });
        
        alert('Friend request declined');
        
      } catch (error) {
        console.error('Error declining friend request:', error);
        alert('Error declining friend request');
      }
    }

    // SIMPLE SEARCH USERS
    async function searchUsers() {
      const searchTerm = searchFriendInput.value.trim().toLowerCase();
      if (!searchTerm) {
        searchResults.innerHTML = '<div class="small-muted">Please enter a username to search</div>';
        return;
      }

      searchResults.innerHTML = '<div class="small-muted">Searching...</div>';

      try {
        // Get all users and filter client-side (simpler approach)
        const usersSnapshot = await getDocs(collection(db, 'users'));
        searchResults.innerHTML = '';

        let foundUsers = false;
        
        usersSnapshot.forEach((docSnap) => {
          const userData = docSnap.data();
          
          // Skip current user
          if (docSnap.id === user.uid) return;
          
          // Check if username matches search
          if (userData.username && userData.username.toLowerCase().includes(searchTerm)) {
            foundUsers = true;
            
            const resultItem = document.createElement('div');
            resultItem.className = 'search-result-item';
            resultItem.innerHTML = `
              <div class="friend-avatar">${userData.username?.charAt(0).toUpperCase() || 'U'}</div>
              <div style="flex:1;min-width:0;">
                <strong>@${userData.username || 'user'}</strong>
                <div class="small-muted">${userData.email || 'No email'}</div>
              </div>
              <button class="btn btn-mark btn-add-friend" data-user-id="${docSnap.id}">
                <i class="fa-solid fa-user-plus"></i> Add
              </button>
            `;
            searchResults.appendChild(resultItem);

            resultItem.querySelector('.btn-add-friend').addEventListener('click', async (e) => {
              const targetUserId = e.target.closest('.btn-add-friend').dataset.userId;
              await sendFriendRequest(targetUserId);
            });
          }
        });

        if (!foundUsers) {
          searchResults.innerHTML = '<div class="small-muted">No users found</div>';
        }
      } catch (error) {
        console.error('Error searching users:', error);
        searchResults.innerHTML = '<div class="small-muted">Error searching users</div>';
      }
    }

    // SIMPLE RENDER FRIENDS LIST
    async function renderFriendsList(friendIds) {
      friendsList.innerHTML = '';
      
      if (friendIds.length === 0) {
        friendsList.innerHTML = `
          <div class="empty-friends">
            <i class="fa-solid fa-user-plus"></i>
            <div style="font-size:1.1rem;margin-bottom:0.5rem;font-weight:600">No friends yet</div>
            <div>Add friends to start chatting!</div>
          </div>
        `;
        return;
      }

      for (const friendId of friendIds) {
        try {
          const friendRef = doc(db, 'users', friendId);
          const friendSnap = await getDoc(friendRef);
          
          if (friendSnap.exists()) {
            const friend = friendSnap.data();
            const friendItem = document.createElement('div');
            friendItem.className = 'friend-item';
            friendItem.innerHTML = `
              <div class="friend-avatar">${friend.username?.charAt(0).toUpperCase() || 'F'}</div>
              <div style="flex:1;min-width:0;">
                <strong>@${friend.username || 'user'}</strong>
                <div class="small-muted">${friend.email || 'No email'}</div>
              </div>
            `;
            friendsList.appendChild(friendItem);
          }
        } catch (error) {
          console.error('Error loading friend:', error);
        }
      }
    }

    // SIMPLE RENDER REQUESTS LIST
    async function renderRequestsList(requestIds) {
      requestsList.innerHTML = '';
      
      if (requestIds.length === 0) {
        requestsList.innerHTML = '<div class="small-muted">No pending requests</div>';
        return;
      }

      for (const requestId of requestIds) {
        try {
          const requesterRef = doc(db, 'users', requestId);
          const requesterSnap = await getDoc(requesterRef);
          
          if (requesterSnap.exists()) {
            const requester = requesterSnap.data();
            const requestItem = document.createElement('div');
            requestItem.className = 'request-item';
            requestItem.innerHTML = `
              <div class="friend-avatar">${requester.username?.charAt(0).toUpperCase() || 'U'}</div>
              <div style="flex:1;min-width:0;">
                <strong>@${requester.username || 'user'}</strong>
                <div class="small-muted">Wants to be friends</div>
              </div>
              <div class="request-actions">
                <button class="btn btn-success btn-accept" data-requester-id="${requestId}">
                  <i class="fa-solid fa-check"></i>
                </button>
                <button class="btn btn-danger btn-decline" data-requester-id="${requestId}">
                  <i class="fa-solid fa-times"></i>
                </button>
              </div>
            `;
            requestsList.appendChild(requestItem);

            requestItem.querySelector('.btn-accept').addEventListener('click', async (e) => {
              const requesterId = e.target.closest('.btn-accept').dataset.requesterId;
              await acceptFriendRequest(requesterId);
            });

            requestItem.querySelector('.btn-decline').addEventListener('click', async (e) => {
              const requesterId = e.target.closest('.btn-decline').dataset.requesterId;
              await declineFriendRequest(requesterId);
            });
          }
        } catch (error) {
          console.error('Error loading request:', error);
        }
      }
    }

    // SIMPLE LOAD FRIENDS DATA
    function loadFriendsData() {
      const userRef = doc(db, 'users', user.uid);
      
      const unsubscribe = onSnapshot(userRef, (docSnap) => {
        if (docSnap.exists()) {
          const userData = docSnap.data();
          renderFriendsList(userData.friends || []);
          renderRequestsList(userData.friendRequests || []);
        }
      }, (error) => {
        console.error('Error loading friends data:', error);
        friendsList.innerHTML = '<div class="small-muted">Error loading friends</div>';
      });
    }

    // EVENT LISTENERS
    openAddFriend.addEventListener('click', () => {
      addFriendModal.style.display = 'flex';
      searchFriendInput.value = '';
      searchResults.innerHTML = '<div class="small-muted">Search for users by username</div>';
    });
    
    closeAddFriend.addEventListener('click', () => addFriendModal.style.display = 'none');
    searchFriendBtn.addEventListener('click', searchUsers);
    searchFriendInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') searchUsers();
    });

    // INITIALIZE
    loadFriendsData();
  }

  // ===== STATUS APP =====
  function initializeStatusApp(user) {
    const statusFeed = document.querySelector('.feed');
    const openStatusModal = document.getElementById('openStatusModal');
    const statusModal = document.getElementById('statusModal');
    const closeStatusModal = document.getElementById('closeStatusModal');
    const postStatusBtn = document.getElementById('postStatusBtn');
    const statusInput = document.getElementById('statusInput');

    // Load status updates from friends
    function loadStatusUpdates() {
      const userRef = doc(db, 'users', user.uid);
      
      const unsubscribe = onSnapshot(userRef, async (docSnap) => {
        if (docSnap.exists()) {
          const userData = docSnap.data();
          const friendIds = userData.friends || [];
          
          if (friendIds.length === 0) {
            statusFeed.innerHTML = `
              <div class="empty-status">
                <i class="fa-solid fa-comment"></i>
                <div style="font-size:1.1rem;margin-bottom:0.5rem;font-weight:600">No updates from friends</div>
                <div>When your friends post updates, they'll appear here!</div>
              </div>
            `;
            return;
          }

          // Load statuses from friends
          const statusPromises = friendIds.map(async (friendId) => {
            try {
              const statusQuery = query(
                collection(db, 'users', friendId, 'statuses'),
                orderBy('timestamp', 'desc')
              );
              const statusSnap = await getDocs(statusQuery);
              return statusSnap.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                userId: friendId
              }));
            } catch (error) {
              console.error('Error loading statuses for friend:', friendId, error);
              return [];
            }
          });

          const allStatuses = (await Promise.all(statusPromises)).flat();
          allStatuses.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
          
          renderStatusFeed(allStatuses);
        }
      }, (error) => {
        console.error('Error loading status updates:', error);
        statusFeed.innerHTML = '<div class="small-muted">Error loading updates</div>';
      });
    }

    // Render status feed
    async function renderStatusFeed(statuses) {
      statusFeed.innerHTML = '';
      
      if (statuses.length === 0) {
        statusFeed.innerHTML = `
          <div class="empty-status">
            <i class="fa-solid fa-comment"></i>
            <div style="font-size:1.1rem;margin-bottom:0.5rem;font-weight:600">No updates yet</div>
            <div>Be the first to post an update!</div>
          </div>
        `;
        return;
      }

      for (const status of statuses) {
        try {
          const friendRef = doc(db, 'users', status.userId);
          const friendSnap = await getDoc(friendRef);
          
          if (friendSnap.exists()) {
            const friend = friendSnap.data();
            const statusEl = document.createElement('div');
            statusEl.className = 'post';
            statusEl.innerHTML = `
              <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
                <div class="user-avatar-small">${friend.username?.charAt(0).toUpperCase() || 'U'}</div>
                <div>
                  <h4>@${friend.username || 'user'}</h4>
                  <div class="small-muted">${getTimeAgo(status.timestamp?.toDate())}</div>
                </div>
              </div>
              <div class="status-text">${status.text}</div>
            `;
            statusFeed.appendChild(statusEl);
          }
        } catch (error) {
          console.error('Error rendering status:', error);
        }
      }
    }

    // Post status update
    async function postStatus() {
      const text = statusInput.value.trim();
      if (!text) {
        alert('Please enter a status update');
        return;
      }

      try {
        await addDoc(collection(db, 'users', user.uid, 'statuses'), {
          text: text,
          timestamp: serverTimestamp()
        });
        statusInput.value = '';
        statusModal.style.display = 'none';
      } catch (error) {
        console.error('Error posting status:', error);
        alert('Error posting status. Please try again.');
      }
    }

    // Helper function for time ago
    function getTimeAgo(date) {
      if (!date) return '';
      const now = new Date();
      const diff = now - date;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor(diff / (1000 * 60));
      
      if (hours > 0) return `${hours}h ago`;
      if (minutes > 0) return `${minutes}m ago`;
      return 'Just now';
    }

    // Event listeners
    openStatusModal.addEventListener('click', () => statusModal.style.display = 'flex');
    closeStatusModal.addEventListener('click', () => statusModal.style.display = 'none');
    postStatusBtn.addEventListener('click', postStatus);

    // Initialize
    loadStatusUpdates();
  }

  // ===== HABIT APP =====
  function initializeHabitApp(userEmail) {
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const STORAGE_KEY = `focusforge_habits_${userEmail.replace(/[^a-zA-Z0-9]/g, '_')}_v1`;
    const habitFab = document.getElementById('openAdd');
    const usernameFooter = document.getElementById('usernameFooter');

    function todayStr(){ return new Date().toISOString().slice(0,10); }
    function isoFromDateObj(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10); }
    function addDays(dateStr, n){ const d = new Date(dateStr); d.setDate(d.getDate() + n); return isoFromDateObj(d); }
    function daysBetween(a,b){ return Math.round((new Date(b) - new Date(a))/(1000*60*60*24)); }
    function lastNDates(n, endDateStr=null){
      const arr=[]; const end = endDateStr ? new Date(endDateStr) : new Date();
      for(let i=n-1;i>=0;i--){ const d=new Date(end); d.setDate(end.getDate()-i); arr.push(isoFromDateObj(d)); }
      return arr;
    }

    function loadHabits(){
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      } catch(e) {
        return [];
      }
    }
    function saveHabits(habits){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(habits));
    }

    function uniqueSorted(arr){
      return Array.from(new Set(arr || [])).sort();
    }
    function ensureDefaults(h){
      h.history = uniqueSorted(h.history || []);
      h.color = h.color || '#60a5fa';
      h.createdAt = h.createdAt || todayStr();
      return h;
    }

    function computeStreak(history, refDate=null){
      const today = refDate || todayStr();
      const set = new Set(history || []);
      let streak = 0;
      let cursor = today;
      while(set.has(cursor)){
        streak++;
        cursor = addDays(cursor, -1);
      }
      return streak;
    }

    function scheduleMidnightReset(){
      const now = new Date();
      const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 1, 0);
      const ms = tomorrow - now;
      setTimeout(()=> {
        render();
        setInterval(()=> render(), 24*60*60*1000);
      }, ms);
    }

    const grid = $('#grid');
    const emptyState = $('#emptyState');
    const statsChip = $('#statsChip');

    function updateStatsDisplay(habits){
      const total = habits.length;
      const completedToday = habits.filter(h => (h.history||[]).includes(todayStr())).length;
      statsChip.textContent = `${total} habit${total!==1?'s':''} • ${completedToday} today`;
    }

    function render(){
      const habits = loadHabits().map(ensureDefaults);
      
      if(habits.length === 0){ 
        emptyState.style.display = 'block'; 
        grid.innerHTML = '';
      } else { 
        emptyState.style.display = 'none'; 
      }

      const sorted = habits.slice().sort((a, b) => b.id - a.id);
      grid.innerHTML = '';
      
      sorted.forEach(h => {
        const streak = computeStreak(h.history);
        const pct = Math.min(100, streak);
        const doneToday = (h.history || []).includes(todayStr());
        const size = 36, stroke = 4, radius = (size - stroke)/2;
        const circumference = 2*Math.PI*radius;
        const offset = circumference * (1 - pct/100);

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="progress" title="${streak} day streak">
            <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
              <defs>
                <linearGradient id="g${h.id}" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0%" stop-color="${h.color}"></stop>
                  <stop offset="100%" stop-color="${h.color}"></stop>
                </linearGradient>
              </defs>
              <circle cx="${size/2}" cy="${size/2}" r="${radius}" stroke="rgba(255,255,255,0.03)" stroke-width="${stroke}" fill="none"></circle>
              <circle cx="${size/2}" cy="${size/2}" r="${radius}" stroke="url(#g${h.id})" stroke-width="${stroke}" stroke-linecap="round"
                stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" fill="none" style="transition: stroke-dashoffset 450ms cubic-bezier(.2,.9,.3,1)"></circle>
            </svg>
            <div class="center">
              <div style="font-weight:800">${streak}</div>
              <div style="font-size:8px;color:var(--muted)">days</div>
            </div>
          </div>
          <div class="meta">
            <div class="habit-name" title="${escapeHtml(h.name)}">${escapeHtml(h.name)}</div>
            <div class="habit-note">${escapeHtml(h.note || '')}</div>
            <div class="habit-meta-row">
              <div class="chip">🔥 ${streak} streak</div>
              <div class="chip">${h.history.length} total</div>
            </div>
          </div>
          <div class="habit-actions">
            <button class="btn ${doneToday ? '' : 'btn-mark'} mark-btn" data-id="${h.id}">${doneToday ? '<i class="fa-solid fa-check"></i> Done' : '<i class="fa-solid fa-circle"></i> Mark'}</button>
            <button class="btn btn-more" data-more="${h.id}"><i class="fa-solid fa-ellipsis-vertical"></i></button>
          </div>
        `;

        grid.appendChild(card);

        card.querySelector('.mark-btn').addEventListener('click', () => toggleToday(h.id));
        card.querySelector('[data-more]').addEventListener('click', (e) => openMoreMenu(e, h.id));
      });

      updateStatsDisplay(habits);
    }

    function toggleToday(habitId){
      const habits = loadHabits();
      const idx = habits.findIndex(h => h.id === habitId);
      if(idx < 0) return;
      const today = todayStr();
      const hist = uniqueSorted(habits[idx].history || []);
      const pos = hist.indexOf(today);
      if(pos !== -1){
        if(!confirm('Unmark completion for today?')) return;
        hist.splice(pos,1);
      } else {
        hist.push(today);
      }
      habits[idx].history = uniqueSorted(hist);
      saveHabits(habits);
      render();
    }

    const modalBackdrop = $('#modalBackdrop');
    const modalTitle = $('#modalTitle');
    const habitName = $('#habitName');
    const habitNote = $('#habitNote');
    const habitColor = $('#habitColor');
    let editingId = null;

    $('#openAdd').addEventListener('click', ()=> openAddModal());
    $('#saveHabit').addEventListener('click', saveModalHabit);
    $('#cancelModal').addEventListener('click', ()=> { modalBackdrop.style.display='none'; editingId=null; });

    function openAddModal(){
      editingId = null;
      modalTitle.textContent = 'Add Habit';
      habitName.value = '';
      habitNote.value = '';
      habitColor.value = '#60a5fa';
      modalBackdrop.style.display = 'flex';
      setTimeout(() => habitName.focus(), 100);
    }

    function openEditModal(h){
      editingId = h.id;
      modalTitle.textContent = 'Edit Habit';
      habitName.value = h.name;
      habitNote.value = h.note || '';
      habitColor.value = h.color || '#60a5fa';
      modalBackdrop.style.display = 'flex';
      setTimeout(() => habitName.focus(), 100);
    }

    function saveModalHabit(){
      const name = habitName.value.trim();
      if(!name){ alert('Enter habit name'); return; }
      const note = habitNote.value.trim();
      const color = habitColor.value || '#60a5fa';

      const habits = loadHabits();
      if(editingId){
        const idx = habits.findIndex(h => h.id === editingId);
        if(idx >= 0){
          habits[idx].name = name;
          habits[idx].note = note;
          habits[idx].color = color;
        }
      } else {
        const newH = {
          id: Date.now(),
          name,
          note,
          color,
          history: [],
          createdAt: todayStr()
        };
        habits.push(newH);
      }
      saveHabits(habits);
      modalBackdrop.style.display = 'none';
      editingId = null;
      render();
    }

    const moreMenu = $('#moreMenu');
    let openMenuFor = null;

    function openMoreMenu(e, id){
      e.stopPropagation();
      openMenuFor = id;
      const rect = e.currentTarget.getBoundingClientRect();
      moreMenu.style.left = (rect.left - 100) + 'px';
      moreMenu.style.top = (rect.bottom + 5) + 'px';
      moreMenu.style.display = 'block';
    }
    document.addEventListener('click', (e) => { if(!moreMenu.contains(e.target)) moreMenu.style.display = 'none'; });

    $('#editBtn').addEventListener('click', ()=>{
      moreMenu.style.display = 'none';
      if(!openMenuFor) return;
      const h = loadHabits().find(x => x.id === openMenuFor);
      if(!h) return;
      openEditModal(h);
    });
    $('#deleteBtn').addEventListener('click', ()=>{
      moreMenu.style.display = 'none';
      if(!openMenuFor) return;
      if(!confirm('Delete this habit?')) return;
      let habits = loadHabits();
      habits = habits.filter(h => h.id !== openMenuFor);
      saveHabits(habits);
      render();
    });

    const navItems = $$('.nav-item');
    const sections = $$('.app-section');
    
    navItems.forEach(item => {
      item.addEventListener('click', () => {
        navItems.forEach(n => n.classList.remove('active'));
        sections.forEach(s => s.classList.remove('active'));
        item.classList.add('active');
        
        const targetSection = document.getElementById(item.dataset.target);
        targetSection.classList.add('active');
        targetSection.scrollTop = 0;
        
        // Show FAB only in habits section, hide username in habits section
        if (item.dataset.target === 'habitsSection') {
          habitFab.style.display = 'grid';
          usernameFooter.style.display = 'none';
        } else {
          habitFab.style.display = 'none';
          usernameFooter.style.display = 'block';
        }
      });
    });

    // Set initial state (habits is active by default)
    usernameFooter.style.display = 'none';
    habitFab.style.display = 'grid';

    $('#refreshBtn').addEventListener('click', ()=> render());
    scheduleMidnightReset();
    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    render();
  }
</script>
</body>
</html>
