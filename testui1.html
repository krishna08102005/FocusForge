<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FocusForge ‚Äî Habits (Beginner Friendly)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* ---------- Root / Reset ---------- */
  :root{
    --bg:#04102a;
    --surface:#071827;
    --muted:#94a3b8;
    --accent:#60a5fa;
    --accent-2:#7c3aed;
    --success:#34d399;
    --card:#0b1724;
    --radius:12px;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;}
  html,body{height:100%;background:linear-gradient(180deg,var(--bg),var(--surface));color:#e8f2ff;-webkit-font-smoothing:antialiased;}
  a{color:inherit}

  /* ---------- App shell ---------- */
  .app{min-height:100vh;display:flex;flex-direction:column;background:linear-gradient(180deg,var(--bg),var(--surface));}
  header.app-header{padding:1rem;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));gap:1rem;border-bottom:1px solid rgba(255,255,255,0.03);}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#021025;flex-shrink:0;}
  .title h1{font-size:1.25rem;margin:0}
  .sub{font-size:0.75rem;color:var(--muted);margin-top:0.25rem}
  .header-actions{display:flex;gap:0.5rem;align-items:center}
  .icon-btn{width:40px;height:40px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.02);cursor:pointer;color:var(--muted);flex-shrink:0;}

  /* ---------- Content ---------- */
  .main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
  .content{flex:1;padding:1rem;overflow-y:auto;}

  /* ---------- Sections ---------- */
  section.app-section{display:none;height:100%;}
  section.app-section.active{display:block;}

  /* ---------- Habits (cards) ---------- */
  .section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem;}
  .small-muted{font-size:0.8rem;color:var(--muted);}
  .grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:var(--radius);padding:1rem;display:flex;gap:1rem;align-items:flex-start;border:1px solid rgba(255,255,255,0.03);position:relative;transition:transform 0.2s ease, box-shadow 0.2s ease;}
  .card:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(2,6,23,0.6);}

  .progress{width:60px;height:60px;flex:0 0 60px;display:grid;place-items:center;position:relative;}
  .progress svg{transform:rotate(-90deg);width:60px;height:60px;}
  .progress .center{position:absolute;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:0.7rem;color:#e6eef8;}

  .meta{flex:1;min-width:0;}
  .habit-name{font-weight:700;font-size:1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:0.25rem;}
  .habit-note{font-size:0.8rem;color:var(--muted);margin-bottom:0.5rem;}
  .habit-meta-row{display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;}

  .chip{font-size:0.7rem;padding:0.25rem 0.5rem;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);color:var(--muted);}

  .habit-actions{display:flex;gap:0.5rem;align-items:center;margin-top:0.75rem;}
  .btn{padding:0.5rem 0.75rem;border-radius:8px;border:none;cursor:pointer;font-weight:600;font-size:0.8rem;display:inline-flex;gap:0.25rem;align-items:center;justify-content:center;transition:all 0.2s ease;}
  .btn-mark{background:linear-gradient(90deg,var(--success),#10b981);color:#021;border:none;}
  .btn-more{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:0.5rem;border-radius:8px;}

  .history{display:flex;gap:2px;align-items:end;height:30px;margin-top:0.5rem;justify-content:space-between;}
  .hbar{flex:1;min-width:2px;border-radius:1px;background:rgba(255,255,255,0.06);transition:all 0.3s ease;}
  .hbar.active{background:linear-gradient(180deg,var(--accent),var(--accent-2))}

  /* ---------- FAB & modal ---------- */
  .fab{position:fixed;right:1.5rem;bottom:5rem;z-index:30;width:56px;height:56px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#021025;font-size:1.25rem;cursor:pointer;box-shadow:0 8px 25px rgba(124,58,237,0.3);border:none;transition:transform 0.2s ease;}
  .fab:hover{transform:scale(1.1);}
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.8);display:none;align-items:center;justify-content:center;z-index:40;padding:1rem;}
  .modal{width:100%;max-width:500px;background:linear-gradient(180deg,#061025,#07142a);border-radius:1rem;padding:1.5rem;border:1px solid rgba(255,255,255,0.03);color:#eaf3ff;max-height:90vh;overflow-y:auto;}
  .form-row{display:flex;flex-direction:column;gap:0.5rem;margin-bottom:1rem;}
  .form-row label{color:var(--muted);font-size:0.9rem;font-weight:500;}
  .form-row input,.form-row select,textarea{width:100%;padding:0.75rem;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:#eaf3ff;outline:none;font-size:1rem;transition:border-color 0.2s ease;}
  .form-row input:focus,.form-row select:focus{outline:none;border-color:var(--accent);}
  .form-row select option{background:#061025;color:#eaf3ff;padding:0.5rem;}
  .modal .actions{display:flex;gap:0.75rem;justify-content:flex-end;margin-top:1.5rem;}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--muted);padding:0.75rem 1.25rem;border-radius:8px;cursor:pointer;transition:all 0.2s ease;}
  .ghost:hover{background:rgba(255,255,255,0.05);}
  .btn-modal{background:linear-gradient(90deg,var(--success),#10b981);color:#021;border:none;padding:0.75rem 1.5rem;border-radius:8px;cursor:pointer;font-weight:600;transition:transform 0.2s ease;}
  .btn-modal:hover{transform:translateY(-1px);}

  /* ---------- More menu ---------- */
  .more-menu{position:absolute;background:#061025;border:1px solid rgba(255,255,255,0.1);padding:0.5rem;border-radius:8px;z-index:50;display:none;min-width:140px;box-shadow:0 8px 25px rgba(0,0,0,0.3);}
  .more-menu button{display:block;background:transparent;border:none;color:var(--muted);padding:0.75rem 1rem;width:100%;text-align:left;cursor:pointer;border-radius:6px;font-size:0.9rem;transition:all 0.2s ease;}
  .more-menu button:hover{background:rgba(255,255,255,0.05);color:#e6eef8}

  /* ---------- Bottom nav ---------- */
  .bottom-nav{display:flex;justify-content:space-around;align-items:center;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-top:1px solid rgba(255,255,255,0.03);padding:0.75rem 0.5rem;gap:0.25rem;margin-top:auto;}
  .nav-item{text-align:center;flex:1;color:var(--muted);font-size:0.75rem;cursor:pointer;padding:0.5rem 0.25rem;display:flex;flex-direction:column;align-items:center;gap:0.25rem;transition:all 0.2s ease;border-radius:8px;}
  .nav-item:hover{background:rgba(255,255,255,0.02);}
  .nav-item.active{color:var(--accent);}
  .nav-item i{font-size:1.25rem;}

  /* ---------- Simple sections ---------- */
  .feed{display:flex;flex-direction:column;gap:1rem;}
  .post{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border-radius:12px;padding:1rem;border:1px solid rgba(255,255,255,0.02)}
  .chat-item{display:flex;align-items:center;gap:1rem;padding:1rem;border-radius:10px;border:1px solid rgba(255,255,255,0.02);background:rgba(255,255,255,0.01)}

  footer.app-footer{padding:1rem;border-top:1px solid rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:0.8rem;background:transparent;}

  /* ---------- Empty state ---------- */
  .empty{text-align:center;padding:3rem 2rem;color:var(--muted);display:none;}
  .empty i{font-size:3rem;margin-bottom:1rem;opacity:0.5;}

  /* ---------- Responsive Design ---------- */
  @media (max-width: 768px) {
    .app{min-height:100vh;}
    .content{padding:0.75rem;padding-bottom:5rem;}
    .grid{grid-template-columns:1fr;gap:0.75rem;}
    .card{padding:0.75rem;}
    .section-title{flex-direction:column;align-items:flex-start;gap:0.5rem;}
    .fab{bottom:5.5rem;right:1rem;width:50px;height:50px;font-size:1.1rem;}
    .modal{padding:1.25rem;margin:1rem;}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(180deg, var(--surface), var(--bg));backdrop-filter:blur(10px);border-top:1px solid rgba(255,255,255,0.1);z-index:10;}
  }

  @media (max-width: 480px) {
    header.app-header{padding:0.75rem;}
    .logo{width:36px;height:36px;}
    .title h1{font-size:1.1rem;}
    .content{padding:0.5rem;padding-bottom:5rem;}
    .card{flex-direction:column;gap:0.75rem;}
    .progress{width:50px;height:50px;}
    .progress svg{width:50px;height:50px;}
    .habit-actions{justify-content:space-between;}
  }

  @media (min-width: 1200px) {
    .app{max-width:1400px;margin:0 auto;}
    .grid{grid-template-columns:repeat(auto-fill, minmax(350px, 1fr));}
  }

  @media (min-width: 1600px) {
    .grid{grid-template-columns:repeat(auto-fill, minmax(400px, 1fr));}
  }
</style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="app-header">
      <div class="title" style="display:flex;gap:1rem;align-items:center">
        <div class="logo">FF</div>
        <div>
          <h1>FocusForge</h1>
          <div class="sub">Habits ‚Ä¢ Chats ‚Ä¢ Status</div>
        </div>
      </div>
      <div class="header-actions">
        <div class="icon-btn" id="refreshBtn" title="Refresh"><i class="fa-solid fa-rotate"></i></div>
        <div class="icon-btn" id="searchBtn" title="Search"><i class="fa-solid fa-magnifying-glass"></i></div>
      </div>
    </header>

    <!-- Main content -->
    <div class="main">
      <div class="content">
        <!-- HABITS -->
        <section id="habitsSection" class="app-section active">
          <div class="section-title">
            <div>
              <h2>Habits</h2>
              <div class="small-muted">Daily check-ins & 30-day history</div>
            </div>
            <div class="chip" id="statsChip">0 habits ‚Ä¢ 0 today</div>
          </div>

          <div id="grid" class="grid"></div>

          <div id="emptyState" class="empty">
            <i class="fa-solid fa-list-check"></i>
            <div style="font-size:1.25rem;margin-bottom:0.5rem;font-weight:600">No habits yet</div>
            <div>Create your first habit ‚Äî press + button below</div>
          </div>
        </section>

        <!-- CHATS -->
        <section id="chatsSection" class="app-section">
          <div class="section-title">
            <div>
              <h2>Chats</h2>
              <div class="small-muted">Accountability groups & DMs</div>
            </div>
          </div>
          <div class="chat-list" style="display:flex;flex-direction:column;gap:1rem;">
            <div class="chat-item">
              <div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#021025;flex-shrink:0;">M</div>
              <div style="flex:1;min-width:0;"><strong>Motivation Group</strong><div class="small-muted">Last: Keep grinding üí™</div></div>
            </div>
            <div class="chat-item">
              <div style="width:44px;height:44px;border-radius:10px;background:#0b1220;display:flex;align-items:center;justify-content:center;flex-shrink:0;">R</div>
              <div style="flex:1;min-width:0;"><strong>Ravi</strong><div class="small-muted">Did you log journaling today?</div></div>
            </div>
          </div>
        </section>

        <!-- STATUS -->
        <section id="statusSection" class="app-section">
          <div class="section-title">
            <div>
              <h2>Status</h2>
              <div class="small-muted">Short 24h updates</div>
            </div>
          </div>
          <div class="feed">
            <div class="post"><h4>@alex</h4><div class="small-muted">Day 10 - Feeling focused!</div></div>
            <div class="post"><h4>@megha</h4><div class="small-muted">Just smashed my morning run!</div></div>
          </div>
        </section>
      </div>
    </div>

    <!-- Footer -->
    <footer class="app-footer">
      <div>Made with ‚ù§Ô∏è</div>
      <!-- Removed the "Last action" display -->
    </footer>

    <!-- Bottom nav -->
    <nav>
      <div class="bottom-nav">
        <div class="nav-item active" data-target="habitsSection"><i class="fa-solid fa-list-check"></i><span>Habits</span></div>
        <div class="nav-item" data-target="chatsSection"><i class="fa-solid fa-comment-dots"></i><span>Chats</span></div>
        <div class="nav-item" data-target="statusSection"><i class="fa-solid fa-circle-plus"></i><span>Status</span></div>
      </div>
    </nav>
  </div>

  <!-- FAB -->
  <button class="fab" id="openAdd" title="Add habit"><i class="fa-solid fa-plus"></i></button>

  <!-- Modal (Add / Edit) -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle" style="margin-bottom:1.5rem;">Add Habit</h3>

      <div class="form-row">
        <label for="habitName">Habit Name</label>
        <input id="habitName" placeholder="e.g., Morning run" maxlength="80" />
      </div>

      <div class="form-row">
        <label for="habitNote">Note (Optional)</label>
        <input id="habitNote" placeholder="Short description" maxlength="120" />
      </div>

      <!-- Removed Goal Days field -->
      
      <div class="form-row">
        <label for="habitColor">Color Theme</label>
        <select id="habitColor">
          <option value="#60a5fa">Blue</option>
          <option value="#f97316">Orange</option>
          <option value="#34d399">Green</option>
          <option value="#f472b6">Pink</option>
          <option value="#7c3aed">Purple</option>
        </select>
      </div>

      <!-- Removed Past Dates field -->

      <div class="actions">
        <button class="ghost" id="cancelModal">Cancel</button>
        <button class="btn-modal" id="saveHabit">Save Habit</button>
      </div>
    </div>
  </div>

  <!-- More menu (edit/delete) -->
  <div class="more-menu" id="moreMenu">
    <button id="editBtn"><i class="fa-solid fa-pen-to-square"></i> Edit</button>
    <button id="deleteBtn"><i class="fa-solid fa-trash"></i> Delete</button>
  </div>

<script>
/* ===================== App JS: Full dynamic habit logic ===================== */

/* ------------------- Utilities ------------------- */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

// Key for localStorage
const STORAGE_KEY = 'focusforge_habits_v1';

// Date helpers
function todayStr(){ return new Date().toISOString().slice(0,10); }
function isoFromDateObj(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10); }
function addDays(dateStr, n){ const d = new Date(dateStr); d.setDate(d.getDate() + n); return isoFromDateObj(d); }
function daysBetween(a,b){ return Math.round((new Date(b) - new Date(a))/(1000*60*60*24)); }
function lastNDates(n, endDateStr=null){
  const arr=[]; const end = endDateStr ? new Date(endDateStr) : new Date();
  for(let i=n-1;i>=0;i--){ const d=new Date(end); d.setDate(end.getDate()-i); arr.push(isoFromDateObj(d)); }
  return arr;
}

/* ------------------- Data model -------------------
habit = {
  id: number,
  name: string,
  note: string,
  color: hex,
  history: ['YYYY-MM-DD', ...], // unique sorted ascending
  createdAt: 'YYYY-MM-DD'
}
------------------- */

// Load / Save
function loadHabits(){
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  } catch(e) {
    console.error('loadHabits parse error', e);
    return [];
  }
}
function saveHabits(habits){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(habits));
  // Removed the last action display update
}

/* ------------------- Default helpers ------------------- */
function uniqueSorted(arr){
  return Array.from(new Set(arr || [])).sort();
}
function ensureDefaults(h){
  h.history = uniqueSorted(h.history || []);
  h.color = h.color || '#60a5fa';
  // Removed goalDays default
  h.createdAt = h.createdAt || todayStr();
  return h;
}

/* ------------------- Streak & stats ------------------- */
function computeStreak(history, refDate=null){
  const today = refDate || todayStr();
  const set = new Set(history || []);
  let streak = 0;
  let cursor = today;
  while(set.has(cursor)){
    streak++;
    cursor = addDays(cursor, -1);
  }
  return streak;
}
function countInLastN(history, n, endDate=null){
  const last = lastNDates(n, endDate);
  const set = new Set(history || []);
  return last.reduce((acc,d)=> acc + (set.has(d) ? 1 : 0), 0);
}

/* ------------------- Daily reset logic -------------------
We want marking to be per-day. On app load we:
- check each habit, if last recorded day isn't today we don't need to forcibly clear history (history is a list of dates).
- But we need to ensure UI shows today as unmarked unless history contains today.
We also schedule a reset at next local midnight to update UI & stats automatically while the app is open.
------------------------------------------------------- */

function scheduleMidnightReset(){
  // calc ms until next local midnight
  const now = new Date();
  const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 1, 0); // 00:01 next day to be safe
  const ms = tomorrow - now;
  // setTimeout once, then setInterval every 24h
  setTimeout(()=> {
    render(); // re-render at midnight so today's marks reset visually if not present
    // then schedule every 24h
    setInterval(()=> render(), 24*60*60*1000);
  }, ms);
}

/* ------------------- Rendering ------------------- */
const grid = $('#grid');
const emptyState = $('#emptyState');
const statsChip = $('#statsChip');

function updateStatsDisplay(habits){
  const total = habits.length;
  const completedToday = habits.filter(h => (h.history||[]).includes(todayStr())).length;
  statsChip.textContent = `${total} habit${total!==1?'s':''} ‚Ä¢ ${completedToday} today`;
}

function render(){
  const habits = loadHabits().map(ensureDefaults);
  
  // UI empty state
  if(habits.length === 0){ 
    emptyState.style.display = 'block'; 
    grid.innerHTML = '';
  } else { 
    emptyState.style.display = 'none'; 
  }

  // CHANGED: Keep habits in their original creation order (newest first)
  const sorted = habits.slice().sort((a, b) => b.id - a.id);

  grid.innerHTML = '';
  sorted.forEach(h => {
    const streak = computeStreak(h.history);
    // Removed goal-based percentage calculation, using streak as the main metric
    const pct = Math.min(100, streak); // Simple percentage based on streak (capped at 100)
    const doneToday = (h.history || []).includes(todayStr());
    const size = 60, stroke = 6, radius = (size - stroke)/2;
    const circumference = 2*Math.PI*radius;
    const offset = circumference * (1 - pct/100);

    // Build card
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="progress" title="${streak} day streak">
        <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
          <defs>
            <linearGradient id="g${h.id}" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="${h.color}"></stop>
              <stop offset="100%" stop-color="${h.color}"></stop>
            </linearGradient>
          </defs>
          <circle cx="${size/2}" cy="${size/2}" r="${radius}" stroke="rgba(255,255,255,0.03)" stroke-width="${stroke}" fill="none"></circle>
          <circle cx="${size/2}" cy="${size/2}" r="${radius}" stroke="url(#g${h.id})" stroke-width="${stroke}" stroke-linecap="round"
            stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" fill="none" style="transition: stroke-dashoffset 450ms cubic-bezier(.2,.9,.3,1)"></circle>
        </svg>
        <div class="center">
          <div style="font-weight:800">${streak}</div>
          <div style="font-size:10px;color:var(--muted)">days</div>
        </div>
      </div>

      <div class="meta">
        <div class="habit-name" title="${escapeHtml(h.name)}">${escapeHtml(h.name)}</div>
        <div class="habit-note">${escapeHtml(h.note || '')}</div>

        <div class="habit-meta-row">
          <div class="chip">üî• ${streak} streak</div>
          <div class="chip">${h.history.length} total</div>
        </div>

        <div class="history" aria-hidden="true"></div>
      </div>

      <div class="habit-actions">
        <button class="btn ${doneToday ? '' : 'btn-mark'} mark-btn" data-id="${h.id}">${doneToday ? '<i class="fa-solid fa-check"></i> Done' : '<i class="fa-solid fa-circle"></i> Mark'}</button>
        <button class="btn btn-more" data-more="${h.id}"><i class="fa-solid fa-ellipsis-vertical"></i></button>
      </div>
    `;

    // append
    grid.appendChild(card);

    // fill history mini-bars (30 days)
    const historyContainer = card.querySelector('.history');
    const last30 = lastNDates(30);
    const set = new Set(h.history || []);
    last30.forEach(d => {
      const bar = document.createElement('div');
      bar.className = 'hbar' + (set.has(d) ? ' active' : '');
      const age = daysBetween(d, todayStr());
      const height = set.has(d) ? Math.max(8, 20 - age*0.3) : 4;
      bar.style.height = height + 'px';
      // Set the bar color to match the habit color
      if(set.has(d)) {
        bar.style.background = h.color;
      }
      historyContainer.appendChild(bar);
    });

    // listeners
    card.querySelector('.mark-btn').addEventListener('click', () => toggleToday(h.id));
    card.querySelector('[data-more]').addEventListener('click', (e) => openMoreMenu(e, h.id));
  });

  updateStatsDisplay(habits);
}

/* ------------------- Mark / Unmark today ------------------- */
function toggleToday(habitId){
  const habits = loadHabits();
  const idx = habits.findIndex(h => h.id === habitId);
  if(idx < 0) return;
  const today = todayStr();
  const hist = uniqueSorted(habits[idx].history || []);
  const pos = hist.indexOf(today);
  if(pos !== -1){
    // unmark today's completion
    if(!confirm('Unmark completion for today?')) return;
    hist.splice(pos,1);
  } else {
    hist.push(today);
  }
  habits[idx].history = uniqueSorted(hist);
  saveHabits(habits);
  render();
}

/* ------------------- Add / Edit Modal ------------------- */
const modalBackdrop = $('#modalBackdrop');
const modalTitle = $('#modalTitle');
const habitName = $('#habitName');
const habitNote = $('#habitNote');
const habitColor = $('#habitColor');
let editingId = null;

$('#openAdd').addEventListener('click', ()=> openAddModal());
$('#saveHabit').addEventListener('click', saveModalHabit);
$('#cancelModal').addEventListener('click', ()=> { modalBackdrop.style.display='none'; editingId=null; });

function openAddModal(){
  editingId = null;
  modalTitle.textContent = 'Add Habit';
  habitName.value = '';
  habitNote.value = '';
  habitColor.value = '#60a5fa';
  modalBackdrop.style.display = 'flex';
  // Focus on first input
  setTimeout(() => habitName.focus(), 100);
}

function openEditModal(h){
  editingId = h.id;
  modalTitle.textContent = 'Edit Habit';
  habitName.value = h.name;
  habitNote.value = h.note || '';
  habitColor.value = h.color || '#60a5fa';
  modalBackdrop.style.display = 'flex';
  // Focus on first input
  setTimeout(() => habitName.focus(), 100);
}

function saveModalHabit(){
  const name = habitName.value.trim();
  if(!name){ alert('Enter habit name'); return; }
  const note = habitNote.value.trim();
  const color = habitColor.value || '#60a5fa';

  const habits = loadHabits();
  if(editingId){
    const idx = habits.findIndex(h => h.id === editingId);
    if(idx >= 0){
      habits[idx].name = name;
      habits[idx].note = note;
      habits[idx].color = color;
    }
  } else {
    const newH = {
      id: Date.now(),
      name,
      note,
      color,
      history: [],
      createdAt: todayStr()
    };
    habits.push(newH);
  }
  saveHabits(habits);
  modalBackdrop.style.display = 'none';
  editingId = null;
  render();
}

/* ------------------- More menu (Edit / Delete) ------------------- */
const moreMenu = $('#moreMenu');
let openMenuFor = null;

function openMoreMenu(e, id){
  e.stopPropagation();
  openMenuFor = id;
  const rect = e.currentTarget.getBoundingClientRect();
  moreMenu.style.left = (rect.left - 120) + 'px';
  moreMenu.style.top = (rect.bottom + 5) + 'px';
  moreMenu.style.display = 'block';
}
document.addEventListener('click', (e) => { if(!moreMenu.contains(e.target)) moreMenu.style.display = 'none'; });

$('#editBtn').addEventListener('click', ()=>{
  moreMenu.style.display = 'none';
  if(!openMenuFor) return;
  const h = loadHabits().find(x => x.id === openMenuFor);
  if(!h) return;
  openEditModal(h);
});
$('#deleteBtn').addEventListener('click', ()=>{
  moreMenu.style.display = 'none';
  if(!openMenuFor) return;
  if(!confirm('Delete this habit? This cannot be undone.')) return;
  let habits = loadHabits();
  habits = habits.filter(h => h.id !== openMenuFor);
  saveHabits(habits);
  render();
});

/* ------------------- Navigation (tabs) ------------------- */
const navItems = $$('.nav-item');
const sections = $$('.app-section');
navItems.forEach(item => {
  item.addEventListener('click', () => {
    navItems.forEach(n => n.classList.remove('active'));
    sections.forEach(s => s.classList.remove('active'));
    item.classList.add('active');
    document.getElementById(item.dataset.target).classList.add('active');
    document.getElementById(item.dataset.target).scrollTop = 0;
  });
});

/* ------------------- Refresh button ------------------- */
$('#refreshBtn').addEventListener('click', ()=> render());

/* ------------------- Midnight reset scheduling ------------------- */
scheduleMidnightReset();

/* ------------------- Escape html helper ------------------- */
function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ------------------- First render ------------------- */
render();

/* ===================== End of App JS ===================== */
</script>
</body>
</html>